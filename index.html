<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rival You - AI Learning Twin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'rival-red': '#EF4444',
                        'student-blue': '#3B82F6'
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s infinite',
                        'bounce-light': 'bounce 2s infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out'
                    },
                    keyframes: {
                        glow: {
                            '0%': { boxShadow: '0 0 5px currentColor' },
                            '100%': { boxShadow: '0 0 20px currentColor, 0 0 30px currentColor' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .avatar-glow {
            filter: drop-shadow(0 0 10px currentColor);
        }
        .progress-bar {
            transition: width 0.8s ease-out, background-color 0.3s ease;
        }
        .battle-arena {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .custom-avatar {
            font-size: 4rem;
            line-height: 1;
            position: relative;
        }
        .demo-banner {
            background: linear-gradient(90deg, #fbbf24, #f59e0b);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen transition-colors">
    
    <!-- Sign Up / Welcome Screen -->
    <div id="welcomeScreen" class="fixed inset-0 bg-gradient-to-br from-gray-50 to-blue-50 flex items-start justify-center z-50 p-4 overflow-y-auto">
        <div class="max-w-4xl w-full my-4 pt-8">
            <!-- Main Sign Up Card -->
            <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 animate-slide-up mb-6">
                <div class="text-center mb-6">
                    <img src="https://pfst.cf2.poecdn.net/base/image/4cdbaf898bfd7432fcfe4133b155ec1d2140d7ce4b2cadd9a4468471170b1391?w=1080&h=1080" alt="Rival You Logo" class="w-32 h-32 mx-auto mb-4 rounded-2xl shadow-lg">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Welcome to Rival You</h1>
                    <p class="text-gray-600 dark:text-gray-400 mt-2">Turn learning into an epic battle!</p>
                </div>

                <!-- Role Selection Tabs -->
                <div class="flex border-b border-gray-200 dark:border-gray-600 mb-6">
                    <button onclick="switchSignUpTab('student')" id="studentSignUpTab" class="flex-1 px-4 py-3 font-medium border-b-2 border-primary text-primary">
                        üë®‚Äçüéì Student Sign Up
                    </button>
                    <button onclick="switchSignUpTab('teacher')" id="teacherSignUpTab" class="flex-1 px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        üë©‚Äçüè´ Teacher Sign Up
                    </button>
                </div>

                <!-- Student Sign Up Form -->
                <div id="studentSignUpForm" class="grid md:grid-cols-2 gap-6">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Student Name</label>
                            <input type="text" id="studentUsername" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Choose your warrior name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                            <input type="email" id="studentEmail" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="student@school.edu">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Grade Level</label>
                            <select id="studentGrade" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Select your grade</option>
                                <option value="6">6th Grade</option>
                                <option value="7">7th Grade</option>
                                <option value="8">8th Grade</option>
                                <option value="9">9th Grade</option>
                                <option value="10">10th Grade</option>
                                <option value="11">11th Grade</option>
                                <option value="12">12th Grade</option>
                            </select>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                            <input type="password" id="studentPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Create a strong password" oninput="checkPasswordStrength('student')">
                            <div class="mt-2">
                                <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">Password must include:</div>
                                <div class="grid grid-cols-2 gap-1 text-xs">
                                    <div id="studentReq1" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> 8+ characters
                                    </div>
                                    <div id="studentReq2" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> Uppercase letter
                                    </div>
                                    <div id="studentReq3" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> Lowercase letter
                                    </div>
                                    <div id="studentReq4" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> Number
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirm Password</label>
                            <input type="password" id="studentConfirmPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Re-enter your password" oninput="checkPasswordMatch('student')">
                            <div id="studentPasswordMatch" class="mt-1 text-xs hidden"></div>
                        </div>

                        <button onclick="signUpStudentUpdated()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium text-base">
                            Start My Battle Journey! ‚öîÔ∏è
                        </button>
                        
                        <div class="text-center text-sm text-gray-500 dark:text-gray-400">
                            Join the fight against procrastination!
                        </div>
                    </div>
                </div>

                <!-- Teacher Sign Up Form -->
                <div id="teacherSignUpForm" class="grid md:grid-cols-2 gap-6 hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Teacher Name</label>
                            <input type="text" id="teacherUsername" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Ms. Johnson">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">School Email</label>
                            <input type="email" id="teacherEmail" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="teacher@school.edu">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Subject Area</label>
                            <select id="teacherSubject" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Select your primary subject</option>
                                <option value="math">Mathematics</option>
                                <option value="science">Science</option>
                                <option value="english">English/Language Arts</option>
                                <option value="history">History/Social Studies</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">School Name</label>
                            <input type="text" id="schoolName" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Washington High School">
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Password</label>
                            <input type="password" id="teacherPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Create a secure password" oninput="checkPasswordStrength('teacher')">
                            <div class="mt-2">
                                <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">Password must include:</div>
                                <div class="grid grid-cols-2 gap-1 text-xs">
                                    <div id="teacherReq1" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> 8+ characters
                                    </div>
                                    <div id="teacherReq2" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> Uppercase letter
                                    </div>
                                    <div id="teacherReq3" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> Lowercase letter
                                    </div>
                                    <div id="teacherReq4" class="flex items-center text-gray-500">
                                        <span class="mr-1">‚óã</span> Number
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Confirm Password</label>
                            <input type="password" id="teacherConfirmPassword" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Re-enter your password" oninput="checkPasswordMatch('teacher')">
                            <div id="teacherPasswordMatch" class="mt-1 text-xs hidden"></div>
                        </div>

                        <button onclick="signUpTeacherUpdated()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium text-base">
                            Create Teacher Account üë©‚Äçüè´
                        </button>
                        
                        <div class="text-center text-sm text-gray-500 dark:text-gray-400">
                            Gamify your classroom assignments!
                        </div>
                    </div>
                </div>


            </div>

            <!-- Demo & Pricing Section - Outside the main card -->
            <div class="grid md:grid-cols-2 gap-4">
                <!-- Demo Section -->
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-xl shadow-lg p-6">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">Try Demo Mode</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Experience both student and teacher views</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="enterStudentDemo()" class="bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium text-sm">
                            üë®‚Äçüéì Student Demo
                        </button>
                        <button onclick="enterTeacherDemo()" class="bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium text-sm">
                            üë©‚Äçüè´ Teacher Demo
                        </button>
                    </div>
                    
                    <div class="mt-3 text-xs text-center text-gray-400 dark:text-gray-500">
                        ‚ö†Ô∏è Demo progress won't be saved
                    </div>
                </div>

                <!-- Pricing Section -->
                <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-xl shadow-lg p-6">
                    <div class="text-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300">View Plans</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Choose your adventure level</p>
                    </div>
                    
                    <button onclick="openSubscriptionModal()" class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-lg hover:from-green-700 hover:to-blue-700 transition-all font-medium text-sm">
                        üí∞ View Pricing Plans
                    </button>
                    
                    <div class="mt-3 text-xs text-center text-gray-400 dark:text-gray-500">
                        Free plan available
                    </div>
                </div>
            </div>

            <!-- Landing Page Footer -->
            <div class="mt-8 pt-6 border-t border-gray-200 dark:border-gray-600">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center space-x-4 mb-4 md:mb-0">
                        <img src="https://pfst.cf2.poecdn.net/base/image/be94ad793df5c5fef6abb3606c29b6e8f15daaa53635ceb2e12adf1f3817c520?w=1080&h=1080" alt="Cortexo Logo" class="w-12 h-12 rounded-lg">
                        <div>
                            <div class="text-lg font-bold text-gray-800 dark:text-gray-200">Cortexo</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Where Education Meets Adventure</div>
                        </div>
                    </div>
                    
                    <div class="text-center md:text-right">
                        <div class="text-sm text-gray-600 dark:text-gray-400">
                            ¬© 2025 Cortexo. All rights reserved.
                        </div>
                        <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                            Transforming learning into epic adventures
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Demo Mode Banner -->
    <div id="demoBanner" class="demo-banner text-white py-2 px-4 text-center text-sm font-medium hidden">
        üéÆ Demo Mode - Progress won't be saved | 
        <button onclick="showWelcomeScreen()" class="underline hover:no-underline ml-2">Sign Up to Save Progress</button>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-6xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between min-h-[48px]">
                <div class="flex items-center space-x-3 min-w-0">
                    <img src="https://pfst.cf2.poecdn.net/base/image/d8a0c0161f0dc8666c5197238093e8d8c7a3a51380a4b3b77a77a94a34f8628a?w=2191&h=634" alt="Rival You Logo" class="h-10 w-auto rounded-lg flex-shrink-0">
                </div>
                <div class="flex items-center space-x-2 md:space-x-4 min-w-0">
                    <div class="flex items-center space-x-2 min-w-0">
                        <span id="userWelcome" class="text-sm text-gray-600 dark:text-gray-400 hidden truncate">Welcome, <span id="displayUsername" class="font-semibold"></span>!</span>
                    </div>
                    
                    <!-- Back to Sign Up Button (for demo users) -->
                    <button id="backToSignUpBtn" onclick="showWelcomeScreen()" class="hidden flex items-center space-x-1 md:space-x-2 bg-blue-600 text-white hover:bg-blue-700 px-2 md:px-4 py-2 rounded-lg transition-colors font-medium text-sm whitespace-nowrap">
                        <span class="hidden md:inline">‚Üê Back to Sign Up</span>
                        <span class="md:hidden">‚Üê Sign Up</span>
                    </button>
                    
                    <button onclick="openAvatarSelection()" class="flex items-center space-x-1 md:space-x-2 bg-gray-600 text-white hover:bg-gray-700 px-2 md:px-4 py-2 rounded-lg transition-colors font-medium text-sm whitespace-nowrap">
                        <div id="headerAvatar" class="text-sm">üß†</div>
                        <span class="hidden md:inline">Avatar</span>
                    </button>
                    
                    <!-- Teacher Mode Toggle -->
                    <button id="teacherModeBtn" onclick="toggleTeacherMode()" class="hidden flex items-center space-x-1 md:space-x-2 bg-purple-600 text-white hover:bg-purple-700 px-2 md:px-4 py-2 rounded-lg transition-colors font-medium text-sm whitespace-nowrap">
                        <span class="hidden md:inline">üë©‚Äçüè´ Teacher Mode</span>
                        <span class="md:hidden">üë©‚Äçüè´</span>
                    </button>
                    
                    <div class="text-xs md:text-sm text-gray-600 dark:text-gray-400 whitespace-nowrap">
                        Week <span id="currentWeek" class="font-semibold">1</span>
                    </div>
                    <div class="text-xs md:text-sm whitespace-nowrap">
                        <span class="text-gray-600 dark:text-gray-400 hidden md:inline">Next Battle:</span>
                        <span class="text-gray-600 dark:text-gray-400 md:hidden">Battle:</span>
                        <span id="battleCountdown" class="font-semibold text-primary ml-1">5d 12h</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto px-4 py-6 space-y-8">
        <!-- Battle Arena -->
        <div class="battle-arena rounded-2xl p-8 text-white relative overflow-hidden">
            <div class="glass-effect rounded-xl p-6">
                <h2 class="text-3xl font-bold text-center mb-6">‚öîÔ∏è Battle Arena</h2>
                
                <!-- Battle Mode Selection -->
                <div class="flex justify-center mb-8">
                    <div class="bg-white/20 rounded-lg p-2 flex space-x-2">
                        <button onclick="switchBattleMode('bot')" id="botModeBtn" class="px-4 py-2 rounded-md bg-white/30 text-white font-medium transition-all">
                            ü§ñ VS AI Rival
                        </button>
                        <button onclick="switchBattleMode('classmates')" id="classmatesModeBtn" class="px-4 py-2 rounded-md text-white/70 hover:bg-white/20 font-medium transition-all">
                            üë• VS Classmates
                        </button>
                    </div>
                </div>
                
                <!-- AI Rival Battle View -->
                <div id="botBattleView" class="grid md:grid-cols-3 gap-8 items-center">
                    <!-- Student Side -->
                    <div class="text-center space-y-4">
                        <div class="relative">
                            <div id="studentAvatar" class="text-8xl mx-auto avatar-glow text-student-blue transition-all duration-500">
                                üß†
                            </div>
                            <div id="studentLevel" class="absolute -top-2 -right-2 bg-student-blue text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-lg animate-glow">
                                5
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold">You</h3>
                        <div id="studentRankTitle" class="text-sm font-semibold text-blue-200 mb-2">Academic Fighter</div>
                        <div class="bg-white/20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-2">Level 5 Progress</div>
                            <div class="bg-white/30 rounded-full h-6 overflow-hidden mb-2">
                                <div id="studentXPBar" class="progress-bar bg-gradient-to-r from-blue-400 to-blue-600 h-full rounded-full" style="width: 62%"></div>
                            </div>
                            <div class="text-xs opacity-80">
                                <span id="studentXPDisplay">1,250 XP</span> / <span id="studentNextLevelXP">1,400 XP</span>
                            </div>
                        </div>
                        <div class="text-sm opacity-90">
                            Status: <span id="studentStatus" class="font-semibold text-green-300">Growing Stronger! üí™</span>
                        </div>
                    </div>

                    <!-- VS Divider -->
                    <div class="text-center flex flex-col justify-center">
                        <div class="text-6xl font-bold opacity-50 mb-4">VS</div>
                        <div class="md:hidden w-full h-px bg-white/30 my-4"></div>
                    </div>

                    <!-- Rival Side -->
                    <div class="text-center space-y-4">
                        <div class="relative">
                            <div id="rivalAvatar" class="text-8xl mx-auto avatar-glow text-rival-red transition-all duration-500">
                                ü§ñ
                            </div>
                            <div id="rivalLevel" class="absolute -top-2 -right-2 bg-rival-red text-white rounded-full w-12 h-12 flex items-center justify-center font-bold text-lg animate-glow">
                                2
                            </div>
                        </div>
                        <h3 class="text-2xl font-bold">Rival You</h3>
                        <div id="rivalRankTitle" class="text-sm font-semibold text-red-200 mb-2">Study Blocker</div>
                        <div class="bg-white/20 rounded-lg p-4">
                            <div class="text-sm opacity-90 mb-2">Level 2 Progress</div>
                            <div class="bg-white/30 rounded-full h-6 overflow-hidden mb-2">
                                <div id="rivalXPBar" class="progress-bar bg-gradient-to-r from-red-400 to-red-600 h-full rounded-full" style="width: 60%"></div>
                            </div>
                            <div class="text-xs opacity-80">
                                <span id="rivalXPDisplay">400 XP</span> / <span id="rivalNextLevelXP">450 XP</span>
                            </div>
                        </div>
                        <div class="text-sm opacity-90">
                            Status: <span id="rivalStatus" class="font-semibold text-orange-300">Weakening... üò∞</span>
                        </div>
                    </div>
                </div>

                <!-- Classmates Battle View -->
                <div id="classmatesBattleView" class="hidden">
                    <div class="text-center mb-6">
                        <h3 class="text-2xl font-bold text-white mb-2">üèÜ Class Leaderboard</h3>
                        <p class="text-white/80">Challenge your classmates to epic study battles!</p>
                    </div>
                    
                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Top 3 Students -->
                        <div class="bg-white/20 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-6xl mb-2">ü•á</div>
                                <div class="text-lg font-bold text-yellow-300">Alex Johnson</div>
                                <div class="text-sm opacity-80">Level 6 ‚Ä¢ 1,420 XP</div>
                                <div class="text-xs text-yellow-200 mt-1">Brain Champion</div>
                                <button onclick="challengeClassmate('Alex Johnson', 'üß†', 6)" class="mt-3 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 transition-colors text-sm">
                                    ‚öîÔ∏è Challenge
                                </button>
                            </div>
                        </div>
                        
                        <div class="bg-white/20 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-6xl mb-2">ü•à</div>
                                <div class="text-lg font-bold text-gray-300">Demo Student</div>
                                <div class="text-sm opacity-80">Level 5 ‚Ä¢ 1,250 XP</div>
                                <div class="text-xs text-blue-200 mt-1">Academic Fighter</div>
                                <div class="mt-3 bg-blue-500 text-white px-4 py-2 rounded text-sm">
                                    üëë You
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white/20 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-6xl mb-2">ü•â</div>
                                <div class="text-lg font-bold text-orange-300">Emma Davis</div>
                                <div class="text-sm opacity-80">Level 5 ‚Ä¢ 1,180 XP</div>
                                <div class="text-xs text-blue-200 mt-1">Academic Fighter</div>
                                <button onclick="challengeClassmate('Emma Davis', 'üòé', 5)" class="mt-3 bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 transition-colors text-sm">
                                    ‚öîÔ∏è Challenge
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Other Classmates -->
                    <div class="mt-6 bg-white/10 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-white mb-4">Other Classmates</h4>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="flex items-center justify-between bg-white/10 rounded p-3">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">ü§ì</span>
                                    <div>
                                        <div class="font-medium text-white">Michael Chen</div>
                                        <div class="text-xs text-white/70">Level 3 ‚Ä¢ 520 XP</div>
                                    </div>
                                </div>
                                <button onclick="challengeClassmate('Michael Chen', 'ü§ì', 3)" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600 transition-colors text-sm">
                                    Challenge
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between bg-white/10 rounded p-3">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">üåü</span>
                                    <div>
                                        <div class="font-medium text-white">Sarah Wilson</div>
                                        <div class="text-xs text-white/70">Level 4 ‚Ä¢ 750 XP</div>
                                    </div>
                                </div>
                                <button onclick="challengeClassmate('Sarah Wilson', 'üåü', 4)" class="bg-purple-500 text-white px-3 py-1 rounded hover:bg-purple-600 transition-colors text-sm">
                                    Challenge
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between bg-white/10 rounded p-3">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">ü¶Ö</span>
                                    <div>
                                        <div class="font-medium text-white">David Lopez</div>
                                        <div class="text-xs text-white/70">Level 2 ‚Ä¢ 280 XP</div>
                                    </div>
                                </div>
                                <button onclick="challengeClassmate('David Lopez', 'ü¶Ö', 2)" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition-colors text-sm">
                                    Challenge
                                </button>
                            </div>
                            
                            <div class="flex items-center justify-between bg-white/10 rounded p-3">
                                <div class="flex items-center space-x-3">
                                    <span class="text-2xl">‚ö°</span>
                                    <div>
                                        <div class="font-medium text-white">Lisa Park</div>
                                        <div class="text-xs text-white/70">Level 4 ‚Ä¢ 890 XP</div>
                                    </div>
                                </div>
                                <button onclick="challengeClassmate('Lisa Park', '‚ö°', 4)" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 transition-colors text-sm">
                                    Challenge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Battle Prediction -->
                <div class="mt-8 text-center">
                    <div class="inline-block bg-white/20 rounded-lg px-6 py-3">
                        <div class="text-sm opacity-90 mb-1">Current Battle Prediction</div>
                        <div id="battlePrediction" class="text-xl font-bold text-green-300">You're winning! üèÜ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Center -->
        <div class="grid md:grid-cols-3 gap-8">
            <!-- Test Revision Battles -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    üìö Test Revision Battles
                    <span class="ml-2 text-sm bg-yellow-500 text-white px-2 py-1 rounded-full">Ready to Fight!</span>
                </h3>
                
                <div class="space-y-3 mb-4">
                    <div id="revisionTask1" class="assignment-item bg-gradient-to-r from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 rounded-lg p-4 border-l-4 border-yellow-400">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-bold text-yellow-700 dark:text-yellow-400">Algebra Test Prep</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Mrs. Johnson ‚Ä¢ Test on Friday</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300 mt-2">Quadratic equations, graphing, word problems</div>
                                <div class="flex items-center mt-2 space-x-2">
                                    <span class="text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 px-2 py-1 rounded">Math Revision</span>
                                    <span class="text-xs text-gray-500">‚ö° 10 battle questions</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="enterBattlefield('revisionTask1', 'Algebra Test Prep', 'algebra')" class="w-full mt-4 bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600 transition-colors font-medium flex items-center justify-center space-x-2">
                            <span>‚öîÔ∏è</span>
                            <span>Enter Battlefield</span>
                        </button>
                    </div>

                    <div id="revisionTask2" class="assignment-item bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-lg p-4 border-l-4 border-blue-400">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-bold text-blue-700 dark:text-blue-400">Chemistry Test Review</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Mr. Davis ‚Ä¢ Test next Monday</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300 mt-2">Periodic table, chemical bonds, reactions</div>
                                <div class="flex items-center mt-2 space-x-2">
                                    <span class="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">Science Revision</span>
                                    <span class="text-xs text-gray-500">‚ö° 8 battle questions</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="enterBattlefield('revisionTask2', 'Chemistry Test Review', 'chemistry')" class="w-full mt-4 bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center space-x-2">
                            <span>‚öîÔ∏è</span>
                            <span>Enter Battlefield</span>
                        </button>
                    </div>

                    <div id="revisionTask3" class="assignment-item bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 rounded-lg p-4 border-l-4 border-green-400">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="font-bold text-green-700 dark:text-green-400">History Exam Prep</div>
                                <div class="text-sm text-gray-600 dark:text-gray-400 mt-1">Ms. Rodriguez ‚Ä¢ Exam in 2 weeks</div>
                                <div class="text-sm text-gray-700 dark:text-gray-300 mt-2">World War II, causes and consequences</div>
                                <div class="flex items-center mt-2 space-x-2">
                                    <span class="text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 px-2 py-1 rounded">History Revision</span>
                                    <span class="text-xs text-gray-500">‚ö° 12 battle questions</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="enterBattlefield('revisionTask3', 'History Exam Prep', 'history')" class="w-full mt-4 bg-green-500 text-white py-2 rounded-lg hover:bg-green-600 transition-colors font-medium flex items-center justify-center space-x-2">
                            <span>‚öîÔ∏è</span>
                            <span>Enter Battlefield</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Study Tasks -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    üìö Practice Tasks
                    <span class="ml-2 text-sm bg-student-blue text-white px-2 py-1 rounded-full">Quick Attack!</span>
                </h3>
                
                <div class="space-y-3 mb-4">
                    <div class="task-item bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="startPracticeTask('math')">
                        <div>
                            <div class="font-medium">Math Practice</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Complete 3 problems</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-rival-red font-semibold">-15 Rival Power</div>
                            <div class="text-xs text-gray-500">‚è±Ô∏è 5min</div>
                        </div>
                    </div>

                    <div class="task-item bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="startPracticeTask('science')">
                        <div>
                            <div class="font-medium">Science Quiz</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Quick science questions</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-rival-red font-semibold">-20 Rival Power</div>
                            <div class="text-xs text-gray-500">‚è±Ô∏è 5min</div>
                        </div>
                    </div>

                    <div class="task-item bg-gray-50 dark:bg-gray-700 rounded-lg p-3 flex items-center justify-between hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors cursor-pointer" onclick="startPracticeTask('reading')">
                        <div>
                            <div class="font-medium">Reading Comprehension</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">Analyze a short passage</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-rival-red font-semibold">-10 Rival Power</div>
                            <div class="text-xs text-gray-500">‚è±Ô∏è 3min</div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Learning Tips & Insights -->
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    üí° Learning Tips & Insights
                    <span class="ml-2 text-sm bg-green-500 text-white px-2 py-1 rounded-full">AI Coach</span>
                </h3>
                
                <!-- Performance Insights -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3 text-green-600 dark:text-green-400">üìà Your Patterns</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-start space-x-2">
                            <span class="text-green-500 mt-1">‚úì</span>
                            <span class="text-gray-700 dark:text-gray-300">You're strongest in the morning sessions (85% accuracy)</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-yellow-500 mt-1">‚ö†</span>
                            <span class="text-gray-700 dark:text-gray-300">Math word problems need more practice (60% accuracy)</span>
                        </div>
                        <div class="flex items-start space-x-2">
                            <span class="text-red-500 mt-1">!</span>
                            <span class="text-gray-700 dark:text-gray-300">Chemistry formulas - common mistakes with valence electrons</span>
                        </div>
                    </div>
                </div>

                <!-- AI Suggestions -->
                <div class="mb-6">
                    <h4 class="font-semibold mb-3 text-blue-600 dark:text-blue-400">üéØ AI Suggestions</h4>
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 text-sm">
                        <div class="font-medium text-blue-700 dark:text-blue-300 mb-2">Focus Areas for Maximum Impact:</div>
                        <ul class="space-y-1 text-blue-600 dark:text-blue-400">
                            <li>‚Ä¢ Practice quadratic equations for 15 minutes daily</li>
                            <li>‚Ä¢ Review periodic table trends before chemistry quiz</li>
                            <li>‚Ä¢ Use visual diagrams for word problems</li>
                        </ul>
                    </div>
                </div>

                <!-- AI Tutor Chat -->
                <div class="mb-6">
                    <button onclick="openAITutorChat()" id="rhinoChatButton" class="w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 rounded-lg hover:from-purple-600 hover:to-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <div class="flex items-center justify-center space-x-3">
                            <span class="text-2xl">ü¶è</span>
                            <div class="text-left">
                                <div class="font-bold">Chat with Rhino</div>
                                <div class="text-sm opacity-90">Ask questions, get help instantly!</div>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- Progress Stats -->
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 dark:text-gray-400 text-sm">Tasks Completed Today</span>
                        <span id="tasksToday" class="font-bold text-student-blue">3</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 dark:text-gray-400 text-sm">Current Streak</span>
                        <span id="currentStreak" class="font-bold text-green-500">5 days üî•</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <span class="text-gray-600 dark:text-gray-400 text-sm">Battles Won</span>
                        <span id="battlesWon" class="font-bold text-yellow-500">2/3 üèÜ</span>
                    </div>
                </div>

                <!-- Weekly Progress Chart -->
                <div class="mt-4">
                    <h4 class="font-medium mb-3 text-sm">This Week's Performance</h4>
                    <div class="grid grid-cols-7 gap-1">
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">M</div>
                            <div class="h-6 bg-student-blue rounded-sm relative">
                                <div class="absolute inset-0 bg-student-blue rounded-sm" style="height: 80%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">T</div>
                            <div class="h-6 bg-gray-200 dark:bg-gray-600 rounded-sm relative">
                                <div class="absolute bottom-0 bg-student-blue rounded-sm" style="height: 60%; width: 100%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">W</div>
                            <div class="h-6 bg-gray-200 dark:bg-gray-600 rounded-sm relative">
                                <div class="absolute bottom-0 bg-student-blue rounded-sm" style="height: 100%; width: 100%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">T</div>
                            <div class="h-6 bg-gray-200 dark:bg-gray-600 rounded-sm relative">
                                <div class="absolute bottom-0 bg-student-blue rounded-sm" style="height: 40%; width: 100%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">F</div>
                            <div class="h-6 bg-gray-200 dark:bg-gray-600 rounded-sm relative">
                                <div class="absolute bottom-0 bg-student-blue rounded-sm" style="height: 90%; width: 100%"></div>
                            </div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">S</div>
                            <div class="h-6 bg-gray-200 dark:bg-gray-600 rounded-sm"></div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">S</div>
                            <div class="h-6 bg-gray-200 dark:bg-gray-600 rounded-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rival Messages -->
        <div class="bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 rounded-xl p-6 border border-red-200 dark:border-red-800">
            <h3 class="text-lg font-bold mb-3 text-red-700 dark:text-red-400">üí¨ Rival You Says:</h3>
            <div id="rivalMessage" class="text-red-600 dark:text-red-300 italic">
                "You've been studying too much lately... I'm getting weaker! üò∞ Maybe you should take a break and let me grow stronger? üòà"
            </div>
            <div class="mt-3 text-sm text-red-500 dark:text-red-400">
                <span id="messageTime">2 minutes ago</span>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-8 mt-12">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center space-x-4 mb-4 md:mb-0">
                    <img src="https://pfst.cf2.poecdn.net/base/image/be94ad793df5c5fef6abb3606c29b6e8f15daaa53635ceb2e12adf1f3817c520?w=1080&h=1080" alt="Cortexo Logo" class="w-12 h-12 rounded-lg">
                    <div>
                        <div class="text-lg font-bold text-gray-800 dark:text-gray-200">Cortexo</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Where Education Meets Adventure</div>
                    </div>
                </div>
                
                <div class="text-center md:text-right">
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        ¬© 2025 Cortexo. All rights reserved.
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                        Transforming learning into epic adventures
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Task Completion Modal -->
    <div id="taskModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4">
            <div class="text-center">
                <div class="text-6xl mb-4">‚öîÔ∏è</div>
                <h3 class="text-2xl font-bold mb-2">Task Completed!</h3>
                <p id="taskCompletionText" class="text-gray-600 dark:text-gray-400 mb-6">
                    You dealt 15 damage to your rival!
                </p>
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-6">
                    <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Power Changes:</div>
                    <div class="flex justify-between">
                        <span class="text-student-blue">You: +5</span>
                        <span class="text-rival-red">Rival: -15</span>
                    </div>
                </div>
                <button onclick="closeTaskModal()" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                    Continue Fighting! üí™
                </button>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div id="quizModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold mb-2">üéØ Custom Quiz</h3>
                <p class="text-gray-600 dark:text-gray-400">AI-generated questions to weaken your rival!</p>
            </div>
            
            <div id="quizContent" class="space-y-6">
                <div class="text-center text-gray-500">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-4"></div>
                    <p>Generating quiz questions...</p>
                </div>
            </div>
            
            <div class="flex space-x-4 mt-6">
                <button onclick="closeQuizModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button id="submitQuizBtn" onclick="submitQuiz()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors hidden">
                    Submit Quiz
                </button>
            </div>
        </div>
    </div>

    <!-- Battlefield Quiz Interface -->
    <div id="battlefieldModal" class="fixed inset-0 bg-gradient-to-br from-red-900 to-purple-900 flex items-center justify-center z-50 hidden">
        <div class="max-w-4xl w-full mx-4 h-full max-h-[95vh] overflow-hidden">
            <!-- Battlefield Header -->
            <div class="bg-black/30 backdrop-blur-sm rounded-t-2xl p-6 text-white">
                <div class="flex items-center justify-between">
                    <h2 id="battlefieldTitle" class="text-3xl font-bold">‚öîÔ∏è Algebra Test Prep Battle</h2>
                    <button onclick="exitBattlefield()" class="text-white/70 hover:text-white text-xl">‚úï</button>
                </div>
                
                <!-- Battle Progress -->
                <div class="mt-4 grid grid-cols-2 gap-6">
                    <div class="text-center">
                        <div class="text-lg font-semibold mb-2">Your Power</div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div id="battleStudentPower" class="text-2xl font-bold text-blue-300">75</div>
                            <div class="w-full bg-white/30 rounded-full h-3 mt-2">
                                <div id="battleStudentBar" class="bg-blue-400 h-3 rounded-full transition-all duration-500" style="width: 75%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <div class="text-lg font-semibold mb-2">Rival Power</div>
                        <div class="bg-white/20 rounded-lg p-3">
                            <div id="battleRivalPower" class="text-2xl font-bold text-red-300">25</div>
                            <div class="w-full bg-white/30 rounded-full h-3 mt-2">
                                <div id="battleRivalBar" class="bg-red-400 h-3 rounded-full transition-all duration-500" style="width: 25%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Question Progress -->
                <div class="mt-4 text-center">
                    <div class="text-sm opacity-80">Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">4</span></div>
                    <div class="w-full bg-white/30 rounded-full h-2 mt-2">
                        <div id="questionProgress" class="bg-yellow-400 h-2 rounded-full transition-all duration-300" style="width: 25%"></div>
                    </div>
                </div>
            </div>

            <!-- Question Area -->
            <div class="bg-white dark:bg-gray-800 rounded-b-2xl p-8 max-h-[60vh] overflow-y-auto">
                <div id="battleQuestionContent">
                    <div class="text-center">
                        <div class="text-6xl mb-4">‚öîÔ∏è</div>
                        <h3 class="text-2xl font-bold mb-4">Ready for Battle?</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">Answer questions correctly to damage your rival!</p>
                        <button onclick="startBattleQuiz()" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium text-lg">
                            ‚öîÔ∏è Begin Battle!
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Avatar Selection Modal -->
    <div id="avatarModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-6">
                <h3 class="text-2xl font-bold mb-2">‚öîÔ∏è Customize Your Fighter</h3>
                <p class="text-gray-600 dark:text-gray-400">Create your unique avatar or choose from presets!</p>
            </div>
            
            <!-- Avatar Tabs -->
            <div class="flex border-b border-gray-200 dark:border-gray-600 mb-6">
                <button onclick="switchAvatarTab('custom')" id="customTab" class="px-6 py-3 font-medium border-b-2 border-primary text-primary">Custom Creator</button>
                <button onclick="switchAvatarTab('preset')" id="presetTab" class="px-6 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">Preset Avatars</button>
            </div>

            <!-- Simple Avatar Selection -->
            <div id="customAvatarSection">
                <h4 class="text-lg font-semibold mb-4 text-center">Choose Your Avatar</h4>
                <div class="grid grid-cols-6 gap-4 mb-6">
                    <button onclick="selectAvatar('üòä')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Happy">üòä</button>
                    <button onclick="selectAvatar('üòé')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Cool">üòé</button>
                    <button onclick="selectAvatar('ü§ì')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Nerd">ü§ì</button>
                    <button onclick="selectAvatar('üòÑ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Excited">üòÑ</button>
                    <button onclick="selectAvatar('üôÇ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Content">üôÇ</button>
                    <button onclick="selectAvatar('üòå')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Peaceful">üòå</button>
                </div>
            </div>

            <!-- Preset Avatars -->
            <div id="presetAvatarSection" class="hidden">
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <!-- Student Avatars -->
                    <button onclick="selectAvatar('üß†')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Brain - The Intellectual">üß†</button>
                    <button onclick="selectAvatar('ü¶Ñ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Unicorn - The Magical Learner">ü¶Ñ</button>
                    <button onclick="selectAvatar('ü¶Ö')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Eagle - The Sharp-Eyed">ü¶Ö</button>
                    <button onclick="selectAvatar('‚ö°')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Lightning - The Quick Learner">‚ö°</button>
                    
                    <button onclick="selectAvatar('ü¶Å')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Lion - The Brave Scholar">ü¶Å</button>
                    <button onclick="selectAvatar('üêâ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Dragon - The Wise One">üêâ</button>
                    <button onclick="selectAvatar('üöÄ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Rocket - The High Achiever">üöÄ</button>
                    <button onclick="selectAvatar('üèÜ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Trophy - The Champion">üèÜ</button>
                    
                    <button onclick="selectAvatar('üî•')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Fire - The Passionate">üî•</button>
                    <button onclick="selectAvatar('üíé')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Diamond - The Precious Mind">üíé</button>
                    <button onclick="selectAvatar('üåü')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Star - The Shining Student">üåü</button>
                    <button onclick="selectAvatar('‚≠ê')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Star - The All-Star">‚≠ê</button>
                    
                    <button onclick="selectAvatar('üéØ')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Target - The Focused">üéØ</button>
                    <button onclick="selectAvatar('üí™')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Muscle - The Strong-Willed">üí™</button>
                    <button onclick="selectAvatar('üßô‚Äç‚ôÇÔ∏è')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Wizard - The Knowledgeable">üßô‚Äç‚ôÇÔ∏è</button>
                    <button onclick="selectAvatar('ü¶∏‚Äç‚ôÄÔ∏è')" class="avatar-option text-6xl p-4 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border-2 border-transparent hover:border-primary" title="Superhero - The Mighty Learner">ü¶∏‚Äç‚ôÄÔ∏è</button>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
                    <h4 class="text-lg font-semibold mb-4 text-center">ü§ñ Your Rival's Avatar</h4>
                    <div class="grid grid-cols-4 gap-4">
                        <button onclick="selectRivalAvatar('ü§ñ')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Robot - Classic AI">ü§ñ</button>
                        <button onclick="selectRivalAvatar('üëπ')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Oni - The Demon of Procrastination">üëπ</button>
                        <button onclick="selectRivalAvatar('üòà')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Devil - The Tempter">üòà</button>
                        <button onclick="selectRivalAvatar('üê∫')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Wolf - The Hungry for Laziness">üê∫</button>
                        
                        <button onclick="selectRivalAvatar('üíÄ')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Skull - The Study Killer">üíÄ</button>
                        <button onclick="selectRivalAvatar('ü¶Ö‚Äç‚¨õ')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Dark Eagle - The Shadow of Doubt">ü¶Ö‚Äç‚¨õ</button>
                        <button onclick="selectRivalAvatar('üå™Ô∏è')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Tornado - The Chaos Creator">üå™Ô∏è</button>
                        <button onclick="selectRivalAvatar('üï∑Ô∏è')" class="rival-avatar-option text-6xl p-4 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors border-2 border-transparent hover:border-rival-red" title="Spider - The Web of Distraction">üï∑Ô∏è</button>
                    </div>
                </div>
            </div>
            
            <div class="flex space-x-4 mt-8">
                <button onclick="closeAvatarModal()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition-colors">
                    Cancel
                </button>
                <button onclick="saveAvatarSelection()" class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors">
                    Save Avatar
                </button>
            </div>
        </div>
    </div>

    <!-- Assignment Details Modal -->
    <div id="assignmentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 9999;">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 id="detailsAssignmentTitle" class="text-3xl font-bold mb-2 text-purple-600">Algebra Test Prep</h3>
                        <p id="detailsAssignmentSubject" class="text-gray-600 dark:text-gray-400">Mathematics ‚Ä¢ Due Friday</p>
                    </div>
                    <button onclick="closeAssignmentDetails()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-xl">‚úï</button>
                </div>

                <!-- Assignment Stats -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                        <div class="text-2xl font-bold text-blue-600" id="detailsCompletionRate">64%</div>
                        <div class="text-sm text-blue-700 dark:text-blue-300">Completion Rate</div>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                        <div class="text-2xl font-bold text-green-600" id="detailsAvgScore">78%</div>
                        <div class="text-sm text-green-700 dark:text-green-300">Average Score</div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                        <div class="text-2xl font-bold text-yellow-600" id="detailsBattlesWon">14</div>
                        <div class="text-sm text-yellow-700 dark:text-yellow-300">Battles Won</div>
                    </div>
                    <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4">
                        <div class="text-2xl font-bold text-purple-600" id="detailsAvgTime">4.2m</div>
                        <div class="text-sm text-purple-700 dark:text-purple-300">Avg Time</div>
                    </div>
                </div>

                <!-- Student Results Table -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-semibold">üìä Individual Student Results</h4>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="text-left py-3 px-6">Student</th>
                                    <th class="text-left py-3 px-6">Status</th>
                                    <th class="text-left py-3 px-6">Score</th>
                                    <th class="text-left py-3 px-6">Time Taken</th>
                                    <th class="text-left py-3 px-6">XP Gained</th>
                                    <th class="text-left py-3 px-6">Attempts</th>
                                    <th class="text-left py-3 px-6">Battle Result</th>
                                </tr>
                            </thead>
                            <tbody id="studentResultsTable">
                                <!-- Student results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Question Performance Analysis -->
                <div class="mt-8 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h4 class="text-lg font-semibold">üéØ Question Performance Analysis</h4>
                    </div>
                    
                    <div class="p-6">
                        <div id="questionAnalysis" class="space-y-4">
                            <!-- Question analysis will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Close Button -->
                <div class="mt-8 text-center">
                    <button onclick="closeAssignmentDetails()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                        Close Details
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-7xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="text-center mb-8">
                    <div class="text-6xl mb-4">üöÄ</div>
                    <h2 class="text-3xl font-bold mb-2 text-gray-900 dark:text-white">Welcome to Rival You!</h2>
                    <p class="text-gray-600 dark:text-gray-400 text-lg">Choose your plan to unlock the full battle experience</p>
                </div>

                <!-- Pricing Cards -->
                <div class="grid grid-cols-5 gap-6 mb-8 items-stretch">
                    <!-- Teacher Free - Always Free -->
                    <div class="border-2 border-green-200 dark:border-green-600 rounded-xl p-6 relative bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 flex flex-col">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-green-500 text-white px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap">Always Free</span>
                        </div>
                        
                        <div class="text-center mb-6">
                            <div class="text-3xl mb-2">üë©‚Äçüè´</div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Teacher</h3>
                            <div class="text-3xl font-bold text-green-600 mb-2">$0</div>
                            <div class="text-sm text-gray-500">Forever free for educators</div>
                        </div>
                        
                        <ul class="space-y-3 mb-6 text-xs flex-grow">
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Create unlimited assignments</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>AI question generation</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Class management dashboard</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Student progress analytics</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Battle assignment creation</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Priority support</span>
                            </li>
                        </ul>
                        
                        <button onclick="selectPlan('teacher')" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-medium">
                            Get Started Free
                        </button>
                    </div>

                    <!-- Student Free Tier -->
                    <div class="border-2 border-gray-200 dark:border-gray-600 rounded-xl p-6 relative flex flex-col">
                        <div class="text-center mb-6">
                            <div class="text-3xl mb-2">üèπ</div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Student Free</h3>
                            <div class="text-3xl font-bold text-gray-600 dark:text-gray-400 mb-2">$0</div>
                            <div class="text-sm text-gray-500">Basic battle access</div>
                        </div>
                        
                        <ul class="space-y-3 mb-6 text-xs flex-grow">
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Join classes</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>3 practice battles per day</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Basic XP tracking</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Simple avatar selection</span>
                            </li>
                            <li class="flex items-center text-gray-400">
                                <span class="text-gray-400 mr-2">‚úó</span>
                                <span>Limited AI insights</span>
                            </li>
                            <li class="flex items-center text-gray-400">
                                <span class="text-gray-400 mr-2">‚úó</span>
                                <span>Rival battles blurred</span>
                            </li>
                        </ul>
                        
                        <button onclick="selectPlan('student-free')" class="w-full bg-gray-600 text-white py-3 rounded-lg hover:bg-gray-700 transition-colors font-medium">
                            Continue Free
                        </button>
                    </div>

                    <!-- Student Premium - Most Popular -->
                    <div class="border-2 border-primary rounded-xl p-6 relative bg-gradient-to-br from-primary/5 to-purple-100 dark:to-purple-900/20 flex flex-col">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-primary text-white px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap">Most Popular</span>
                        </div>
                        
                        <div class="text-center mb-6">
                            <div class="text-3xl mb-2">‚öîÔ∏è</div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Student Premium</h3>
                            <div class="text-3xl font-bold text-primary mb-2">$9.99</div>
                            <div class="text-sm text-gray-500">per student/month</div>
                            <div class="text-xs text-primary mt-1">Full battle experience</div>
                        </div>
                        
                        <ul class="space-y-3 mb-6 text-xs flex-grow">
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span><strong>Unlimited battles & practice</strong></span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span><strong>Full AI coach & insights</strong></span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Complete rival battle system</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Classmate vs classmate battles</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Advanced performance analytics</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Priority learning tips</span>
                            </li>
                        </ul>
                        
                        <button onclick="selectPlan('student-premium')" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                            Start 14-Day Trial
                        </button>
                    </div>

                    <!-- Student Annual - Best Value -->
                    <div class="border-2 border-yellow-400 dark:border-yellow-500 rounded-xl p-6 relative bg-gradient-to-br from-yellow-50 to-orange-50 dark:from-yellow-900/20 dark:to-orange-900/20 flex flex-col">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-yellow-500 text-white px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap">Best Value</span>
                        </div>
                        
                        <div class="text-center mb-6">
                            <div class="text-3xl mb-2">üèÜ</div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Student Annual</h3>
                            <div class="text-3xl font-bold text-yellow-600 mb-2">$99</div>
                            <div class="text-sm text-gray-500">per student/year</div>
                            <div class="text-xs text-yellow-600 mt-1">Save $20 annually</div>
                        </div>
                        
                        <ul class="space-y-3 mb-6 text-xs flex-grow">
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span><strong>Everything in Premium</strong></span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Annual progress report</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Early access to new features</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>10% class discount (if 75%+ join)</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Priority support</span>
                            </li>
                        </ul>
                        
                        <button onclick="selectPlan('student-annual')" class="w-full bg-yellow-600 text-white py-3 rounded-lg hover:bg-yellow-700 transition-colors font-medium">
                            Save $20/Year
                        </button>
                    </div>

                    <!-- Schools - Enterprise -->
                    <div class="border-2 border-purple-400 dark:border-purple-500 rounded-xl p-6 relative bg-gradient-to-br from-purple-50 to-indigo-50 dark:from-purple-900/20 dark:to-indigo-900/20 flex flex-col">
                        <div class="absolute -top-3 left-1/2 transform -translate-x-1/2">
                            <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap">Enterprise</span>
                        </div>
                        
                        <div class="text-center mb-6">
                            <div class="text-3xl mb-2">üè´</div>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Schools</h3>
                            <div class="text-3xl font-bold text-purple-600 mb-2">Custom</div>
                            <div class="text-sm text-gray-500">Contact for pricing</div>
                            <div class="text-xs text-purple-600 mt-1">Volume discounts available</div>
                        </div>
                        
                        <ul class="space-y-3 mb-6 text-xs flex-grow">
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span><strong>Everything included</strong></span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>SSO & LMS integrations</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>School-wide analytics</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Custom onboarding & training</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Dedicated account manager</span>
                            </li>
                            <li class="flex items-center">
                                <span class="text-green-500 mr-2">‚úì</span>
                                <span>Volume pricing (500+ students)</span>
                            </li>
                        </ul>
                        
                        <button onclick="selectPlan('enterprise')" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                            Contact Sales
                        </button>
                    </div>
                </div>

                <!-- Bulk Pricing Note -->
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-600 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">üéì Classroom Bulk Pricing</h4>
                    <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                        <p>‚Ä¢ <strong>25+ students:</strong> $7.99/month per student (20% off)</p>
                        <p>‚Ä¢ <strong>Class discount:</strong> 10% off when 75%+ of class joins annually</p>
                        <p>‚Ä¢ <strong>500+ students:</strong> Contact sales for custom volume pricing</p>
                    </div>
                </div>

                <!-- Features Comparison -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 mb-6">
                    <h4 class="text-lg font-bold text-center mb-4">Why Upgrade?</h4>
                    <div class="grid md:grid-cols-3 gap-6 text-center">
                        <div>
                            <div class="text-3xl mb-2">ü§ñ</div>
                            <h5 class="font-semibold mb-2">AI-Powered Learning</h5>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Personalized insights and adaptive difficulty based on your performance</p>
                        </div>
                        <div>
                            <div class="text-3xl mb-2">‚öîÔ∏è</div>
                            <h5 class="font-semibold mb-2">Unlimited Battles</h5>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Practice as much as you want without daily limits</p>
                        </div>
                        <div>
                            <div class="text-3xl mb-2">üìä</div>
                            <h5 class="font-semibold mb-2">Advanced Analytics</h5>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Detailed progress tracking and performance insights</p>
                        </div>
                    </div>
                </div>

                <div class="text-center">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        ‚ú® All plans include: End-to-end encryption, Cancel anytime, Student privacy protection
                    </p>
                    <button onclick="closeSubscriptionModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-sm underline">
                        I'll decide later
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Generation Wizard Modal -->
    <div id="questionWizardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="text-center mb-6">
                    <h3 class="text-3xl font-bold mb-2 text-purple-600">ü§ñ AI Question Generator</h3>
                    <p class="text-gray-600 dark:text-gray-400">Create custom quiz questions for your assignment</p>
                </div>

                <!-- Assignment Summary -->
                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4 mb-6">
                    <h4 class="font-semibold text-purple-800 dark:text-purple-200 mb-2">Assignment Details</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Title:</span> <span id="wizardAssignmentTitle">-</span></div>
                        <div><span class="font-medium">Subject:</span> <span id="wizardAssignmentSubject">-</span></div>
                        <div><span class="font-medium">Questions:</span> <span id="wizardQuestionCount">-</span></div>
                        <div><span class="font-medium">Due Date:</span> <span id="wizardDueDate">-</span></div>
                    </div>
                </div>

                <!-- Content Input Section -->
                <div id="wizardStep1" class="space-y-6">
                    <h4 class="text-xl font-bold mb-4">ü§ñ Create Battle Questions</h4>
                    
                    <!-- Content Source Tabs -->
                    <div class="flex border-b border-gray-200 dark:border-gray-600 mb-6">
                        <button onclick="switchContentTab('create')" id="createContentTab" class="px-4 py-3 font-medium border-b-2 border-purple-600 text-purple-600">
                            ‚úçÔ∏è Create New
                        </button>
                        <button onclick="switchContentTab('paste')" id="pasteContentTab" class="px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            üìù Paste Questions
                        </button>
                        <button onclick="switchContentTab('upload')" id="uploadContentTab" class="px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                            üìÑ Upload PDF
                        </button>
                    </div>

                    <!-- Create New Questions -->
                    <div id="createContentSection">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Topic/Subject to Create Questions About
                            </label>
                            <input type="text" id="questionTopic" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="e.g., Quadratic equations, World War 2, Photosynthesis, Shakespeare">
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Difficulty Level</label>
                                <select id="difficultyLevel" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate" selected>Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Question Style</label>
                                <select id="questionStyle" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="multiple-choice" selected>Multiple Choice</option>
                                    <option value="mixed">Mixed Types</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Paste Questions Section -->
                    <div id="pasteContentSection" class="hidden">
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Paste Your Existing Questions
                            </label>
                            <textarea id="pastedQuestions" rows="8" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Paste your questions here in any format, for example:

1. What is 2+2?
a) 3  b) 4  c) 5  d) 6
Answer: b

2. Who wrote Romeo and Juliet?
A. Charles Dickens
B. William Shakespeare  
C. Mark Twain
D. Jane Austen
Correct: B

AI will automatically format these into multiple choice battle questions!"></textarea>
                        </div>

                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-600 rounded-lg p-4 mb-4">
                            <h5 class="font-medium text-blue-800 dark:text-blue-200 mb-2">üìù Supported Formats:</h5>
                            <div class="text-sm text-blue-700 dark:text-blue-300 space-y-1">
                                <p>‚Ä¢ <strong>Multiple Choice:</strong> Questions with A/B/C/D options</p>
                                <p>‚Ä¢ <strong>True/False:</strong> Simple T/F questions</p>
                                <p>‚Ä¢ <strong>Fill-in-the-blank:</strong> Questions with blanks to fill</p>
                                <p>‚Ä¢ <strong>Short Answer:</strong> Open-ended questions (AI will create choices)</p>
                                <p>‚Ä¢ <strong>Mixed Format:</strong> Combination of different question types</p>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Additional Instructions (optional)
                            </label>
                            <input type="text" id="pasteInstructions" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="e.g., Make all questions multiple choice, focus on key concepts, add explanations...">
                        </div>
                    </div>

                    <!-- PDF Upload Section -->
                    <div id="uploadContentSection" class="hidden">
                        <div class="border-2 border-dashed border-purple-300 dark:border-purple-600 rounded-lg p-8">
                            <div class="text-center">
                                <div class="text-6xl mb-4">üìÑ</div>
                                <h5 class="text-lg font-semibold mb-2">Upload Learning Material</h5>
                                <p class="text-gray-600 dark:text-gray-400 mb-4">
                                    Upload a PDF containing the content you want to create questions from.<br>
                                    <span class="text-sm">(Textbook pages, worksheets, study guides, etc.)</span>
                                </p>
                                
                                <div class="mb-4">
                                    <input type="file" id="pdfUpload" accept=".pdf" class="hidden" onchange="handlePDFUpload(event)">
                                    <button onclick="document.getElementById('pdfUpload').click()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                        üìÅ Choose PDF File
                                    </button>
                                </div>
                                
                                <div id="uploadStatus" class="hidden">
                                    <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-600 rounded-lg p-4">
                                        <div class="flex items-center justify-center space-x-2">
                                            <span class="text-green-600 text-xl">‚úÖ</span>
                                            <div>
                                                <div class="font-medium text-green-800 dark:text-green-200" id="uploadedFileName">document.pdf</div>
                                                <div class="text-sm text-green-600 dark:text-green-400">Ready to generate questions from this content</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-xs text-gray-500 mt-4">
                                    <p>üí° <strong>Pro Tip:</strong> AI will analyze your PDF content and generate relevant questions automatically!</p>
                                    <p class="mt-1">Supported: Educational PDFs up to 10MB</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Instructions for PDF -->
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Additional Instructions (optional)
                            </label>
                            <textarea id="pdfInstructions" rows="3" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="e.g., Focus on chapter 3 concepts, emphasize problem-solving steps, include vocabulary questions..."></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-4">
                        <button onclick="closeQuestionWizard()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            Cancel
                        </button>
                        <button onclick="generateQuestions()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors font-medium">
                            ü§ñ Generate Questions
                        </button>
                    </div>
                </div>

                <!-- Step 2: Review & Edit Questions -->
                <div id="wizardStep2" class="space-y-6 hidden">
                    <div class="flex items-center justify-between">
                        <h4 class="text-xl font-bold">üìã Step 2: Review & Edit Questions</h4>
                        <button onclick="regenerateQuestions()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            üîÑ Regenerate All
                        </button>
                    </div>
                    
                    <div id="questionsList" class="space-y-4">
                        <!-- Generated questions will appear here -->
                    </div>

                    <div class="flex justify-between">
                        <button onclick="goBackToStep1()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                            ‚Üê Back
                        </button>
                        <div class="space-x-4">
                            <button onclick="previewAssignment()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                üëÅÔ∏è Preview
                            </button>
                            <button onclick="deployAssignment()" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                üöÄ Deploy to Students
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div id="wizardLoading" class="text-center py-12 hidden">
                    <div class="text-6xl mb-4">ü§ñ</div>
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full mb-4"></div>
                    <h4 class="text-xl font-bold mb-2">AI is generating your questions...</h4>
                    <p class="text-gray-600 dark:text-gray-400">This may take a few moments</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // App state
        let appState = {
            isSignedUp: false,
            isDemoMode: false,
            username: '',
            email: '',
            customAvatar: {
                base: 'üòä',
                hair: 'ü¶±',
                accessory: 'üéì',
                aura: ''
            }
        };

        // Game state with XP and Levels
        let gameState = {
            studentXP: 1250,
            studentLevel: 5,
            rivalXP: 400,
            rivalLevel: 2,
            tasksCompletedToday: 3,
            currentStreak: 5,
            battlesWon: 2,
            totalBattles: 3,
            totalStudyTime: 12.5
        };

        // Level system configuration
        const levelSystem = {
            // XP required for each level (cumulative)
            xpForLevel: [0, 100, 250, 450, 700, 1000, 1400, 1850, 2350, 2900, 3500, 4150, 4850, 5600, 6400, 7250],
            
            // Student rank titles
            studentRanks: [
                "Newbie Scholar", "Eager Learner", "Study Warrior", "Knowledge Seeker", "Academic Fighter",
                "Brain Champion", "Study Master", "Learning Legend", "Knowledge Hero", "Academic Titan",
                "Study Overlord", "Wisdom Sage", "Learning Deity", "Knowledge God", "Ultimate Scholar"
            ],
            
            // Rival rank titles  
            rivalRanks: [
                "Weak Distraction", "Minor Nuisance", "Study Blocker", "Focus Killer", "Homework Saboteur",
                "Procrastination Beast", "Laziness Demon", "Study Destroyer", "Learning Nemesis", "Academic Nightmare",
                "Knowledge Thief", "Wisdom Crusher", "Ultimate Rival", "Learning Apocalypse", "Education Ender"
            ]
        };

        // Calculate level from XP
        function getXPLevel(xp) {
            for (let level = levelSystem.xpForLevel.length - 1; level >= 0; level--) {
                if (xp >= levelSystem.xpForLevel[level]) {
                    return level;
                }
            }
            return 0;
        }

        // Get XP needed for next level
        function getXPForNextLevel(currentLevel) {
            if (currentLevel >= levelSystem.xpForLevel.length - 1) {
                return levelSystem.xpForLevel[levelSystem.xpForLevel.length - 1]; // Max level
            }
            return levelSystem.xpForLevel[currentLevel + 1];
        }

        // Get current level progress percentage
        function getLevelProgress(xp, level) {
            if (level >= levelSystem.xpForLevel.length - 1) return 100; // Max level
            
            const currentLevelXP = levelSystem.xpForLevel[level];
            const nextLevelXP = levelSystem.xpForLevel[level + 1];
            const progressXP = xp - currentLevelXP;
            const neededXP = nextLevelXP - currentLevelXP;
            
            return Math.min(100, (progressXP / neededXP) * 100);
        }

        // Avatar selection variables
        let selectedStudentAvatar = 'üß†';
        let selectedRivalAvatar = 'ü§ñ';
        let isCustomAvatar = false;

        // Rival messages based on power level
        const rivalMessages = {
            weak: [
                "You've been studying too much lately... I'm getting weaker! üò∞",
                "This is unfair! You're supposed to procrastinate more! üò°",
                "I can barely feel my power... Please stop studying! ü•∫"
            ],
            medium: [
                "We're evenly matched... but I'll grow stronger if you slip up! üòè",
                "Don't get too confident. One missed day and I'll be back! ‚ö°",
                "The battle isn't over yet. I'm watching for your weakness! üëÅÔ∏è"
            ],
            strong: [
                "Yes! You're procrastinating and I'm growing stronger! üòà",
                "Soon I'll be more powerful than you ever imagined! üí™",
                "Keep skipping those tasks... feed my power! üî•"
            ]
        };

        // App state extended
        appState.userRole = ''; // 'student' or 'teacher'
        appState.userDetails = {};

        // Sign up tab switching
        function switchSignUpTab(role) {
            if (role === 'student') {
                document.getElementById('studentSignUpTab').className = 'flex-1 px-4 py-3 font-medium border-b-2 border-primary text-primary';
                document.getElementById('teacherSignUpTab').className = 'flex-1 px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
                document.getElementById('studentSignUpForm').classList.remove('hidden');
                document.getElementById('teacherSignUpForm').classList.add('hidden');
            } else {
                document.getElementById('teacherSignUpTab').className = 'flex-1 px-4 py-3 font-medium border-b-2 border-purple-600 text-purple-600';
                document.getElementById('studentSignUpTab').className = 'flex-1 px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
                document.getElementById('teacherSignUpForm').classList.remove('hidden');
                document.getElementById('studentSignUpForm').classList.add('hidden');
            }
        }

        // Student sign up
        function signUpStudent() {
            const username = document.getElementById('studentUsername').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const password = document.getElementById('studentPassword').value.trim();
            const grade = document.getElementById('studentGrade').value;

            if (!username || !email || !password || !grade) {
                showCustomAlert('Please fill in all fields to start your learning battle!');
                return;
            }

            if (password.length < 8) {
                showCustomAlert('Password must be at least 8 characters long!');
                return;
            }
            
            // Check for secure password requirements
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            
            if (!hasUppercase || !hasLowercase || !hasNumbers) {
                showCustomAlert('Password must contain at least one uppercase letter, one lowercase letter, and one number!');
                return;
            }

            // Set user as student
            appState.isSignedUp = true;
            appState.isDemoMode = false;
            appState.userRole = 'student';
            appState.username = username;
            appState.email = email;
            appState.userDetails = { grade: grade };

            // Hide welcome screen and show student interface (no demo buttons for signed up users)
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('userWelcome').classList.remove('hidden');
            document.getElementById('displayUsername').textContent = username;

            showCustomAlert(`üéÆ Welcome to the battle, ${username}! Your rival awaits... ‚öîÔ∏è`);
        }

        // Teacher sign up
        function signUpTeacher() {
            const username = document.getElementById('teacherUsername').value.trim();
            const email = document.getElementById('teacherEmail').value.trim();
            const password = document.getElementById('teacherPassword').value.trim();
            const subject = document.getElementById('teacherSubject').value;
            const school = document.getElementById('schoolName').value.trim();

            if (!username || !email || !password || !subject || !school) {
                showCustomAlert('Please fill in all fields to create your teacher account!');
                return;
            }

            if (password.length < 8) {
                showCustomAlert('Password must be at least 8 characters long!');
                return;
            }
            
            // Check for secure password requirements
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            
            if (!hasUppercase || !hasLowercase || !hasNumbers) {
                showCustomAlert('Password must contain at least one uppercase letter, one lowercase letter, and one number!');
                return;
            }

            // Set user as teacher and go directly to teacher dashboard
            appState.isSignedUp = true;
            appState.isDemoMode = false;
            appState.userRole = 'teacher';
            appState.username = username;
            appState.email = email;
            appState.userDetails = { subject: subject, school: school };

            // Hide welcome screen and show teacher dashboard (no demo buttons for signed up users)
            document.getElementById('welcomeScreen').classList.add('hidden');
            
            // Show teacher dashboard directly
            showTeacherDashboard();
            
            showCustomAlert(`üë©‚Äçüè´ Welcome to Rival You, ${username}! Ready to gamify your classroom? üè´`);
        }

        // Student demo mode
        function enterStudentDemo() {
            appState.isDemoMode = true;
            appState.isSignedUp = false;
            appState.userRole = 'student';
            appState.username = 'Demo Student';

            // Hide welcome screen and show student interface with demo banner
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('demoBanner').classList.remove('hidden');
            document.getElementById('userWelcome').classList.remove('hidden');
            document.getElementById('displayUsername').textContent = 'Demo Student';
            
            // Show navigation buttons for demo users
            document.getElementById('backToSignUpBtn').classList.remove('hidden');
            document.getElementById('teacherModeBtn').classList.remove('hidden');
            document.getElementById('teacherModeBtn').textContent = 'üë©‚Äçüè´ Teacher Mode';

            showCustomAlert('üéÆ Student Demo Mode! Battle your rival and see how learning becomes epic! Progress won\'t be saved.');
        }

        // Teacher demo mode
        function enterTeacherDemo() {
            appState.isDemoMode = true;
            appState.isSignedUp = false;
            appState.userRole = 'teacher';
            appState.username = 'Demo Teacher';

            // Hide welcome screen 
            document.getElementById('welcomeScreen').classList.add('hidden');
            
            // Hide student interface immediately
            const studentHeader = document.querySelector('header');
            const studentContent = document.querySelector('.max-w-6xl');
            const studentFooter = document.querySelector('footer');
            
            if (studentHeader) studentHeader.style.display = 'none';
            if (studentContent) studentContent.style.display = 'none';
            if (studentFooter) studentFooter.style.display = 'none';
            
            // Show demo banner
            document.getElementById('demoBanner').classList.remove('hidden');
            
            // Show teacher dashboard
            showTeacherDashboard();

            showCustomAlert('üë©‚Äçüè´ Teacher Demo Mode! Create assignments and track student battles! Progress won\'t be saved.');
        }

        // Show welcome screen again
        function showWelcomeScreen() {
            // Hide teacher dashboard if visible
            const teacherDashboard = document.getElementById('teacherDashboard');
            if (teacherDashboard) {
                teacherDashboard.remove();
            }
            
            // Show main interface elements if hidden
            document.querySelector('header').style.display = 'block';
            document.querySelector('.max-w-6xl').style.display = 'block';
            
            // Show welcome screen and hide banners
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('demoBanner').classList.add('hidden');
            
            // Hide user welcome and back button
            document.getElementById('userWelcome').classList.add('hidden');
            document.getElementById('backToSignUpBtn').classList.add('hidden');
            
            // Reset app state
            appState.isSignedUp = false;
            appState.isDemoMode = false;
            appState.userRole = '';
        }

        // Toggle teacher mode for demo users
        function toggleTeacherMode() {
            if (appState.userRole === 'teacher' || document.getElementById('teacherDashboard')) {
                // Switch to student view
                exitTeacherMode();
                appState.userRole = 'student';
                document.getElementById('teacherModeBtn').textContent = 'üë©‚Äçüè´ Teacher Mode';
                
                // IMPORTANT: Show navigation buttons when switching to student mode
                if (appState.isDemoMode) {
                    document.getElementById('backToSignUpBtn').classList.remove('hidden');
                    document.getElementById('teacherModeBtn').classList.remove('hidden');
                }
                
                showCustomAlert('üë®‚Äçüéì Switched to Student View! Experience the battle system.');
            } else {
                // Switch to teacher view
                appState.userRole = 'teacher';
                showTeacherDashboard();
                document.getElementById('teacherModeBtn').textContent = 'üë®‚Äçüéì Student Mode';
                showCustomAlert('üë©‚Äçüè´ Switched to Teacher View! Create and manage assignments.');
            }
        }

        // Custom alert function
        function showCustomAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'fixed top-4 right-4 bg-primary text-white px-6 py-4 rounded-lg shadow-lg z-50 max-w-sm animate-slide-up';
            alertDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="text-2xl">‚öîÔ∏è</div>
                    <div class="flex-1">
                        <p class="text-sm font-medium">${message}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white/70 hover:text-white">‚úï</button>
                </div>
            `;
            document.body.appendChild(alertDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Avatar customization functions
        function switchAvatarTab(tab) {
            if (tab === 'custom') {
                document.getElementById('customTab').className = 'px-6 py-3 font-medium border-b-2 border-primary text-primary';
                document.getElementById('presetTab').className = 'px-6 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
                document.getElementById('customAvatarSection').classList.remove('hidden');
                document.getElementById('presetAvatarSection').classList.add('hidden');
            } else {
                document.getElementById('presetTab').className = 'px-6 py-3 font-medium border-b-2 border-primary text-primary';
                document.getElementById('customTab').className = 'px-6 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
                document.getElementById('presetAvatarSection').classList.remove('hidden');
                document.getElementById('customAvatarSection').classList.add('hidden');
            }
        }

        function updateAvatarPart(part, value) {
            appState.customAvatar[part] = value;
            document.getElementById(`avatar${part.charAt(0).toUpperCase() + part.slice(1)}`).textContent = value;
            isCustomAvatar = true;
        }

        function getCustomAvatarString() {
            return appState.customAvatar.base + appState.customAvatar.hair + appState.customAvatar.accessory + appState.customAvatar.aura;
        }

        // Update XP levels and UI
        function updatePowerLevels() {
            // Update student level and XP display
            gameState.studentLevel = getXPLevel(gameState.studentXP);
            gameState.rivalLevel = getXPLevel(gameState.rivalXP);
            
            const studentLevelEl = document.getElementById('studentLevel');
            const rivalLevelEl = document.getElementById('rivalLevel');
            const studentXPBarEl = document.getElementById('studentXPBar');
            const rivalXPBarEl = document.getElementById('rivalXPBar');
            const studentXPDisplayEl = document.getElementById('studentXPDisplay');
            const rivalXPDisplayEl = document.getElementById('rivalXPDisplay');
            const studentNextLevelXPEl = document.getElementById('studentNextLevelXP');
            const rivalNextLevelXPEl = document.getElementById('rivalNextLevelXP');
            const studentRankTitleEl = document.getElementById('studentRankTitle');
            const rivalRankTitleEl = document.getElementById('rivalRankTitle');
            const studentStatusEl = document.getElementById('studentStatus');
            const rivalStatusEl = document.getElementById('rivalStatus');
            const battlePredictionEl = document.getElementById('battlePrediction');

            // Update level badges
            if (studentLevelEl) studentLevelEl.textContent = gameState.studentLevel;
            if (rivalLevelEl) rivalLevelEl.textContent = gameState.rivalLevel;

            // Update XP displays
            if (studentXPDisplayEl) studentXPDisplayEl.textContent = `${gameState.studentXP} XP`;
            if (rivalXPDisplayEl) rivalXPDisplayEl.textContent = `${gameState.rivalXP} XP`;

            // Update next level XP
            const studentNextLevelXP = getXPForNextLevel(gameState.studentLevel);
            const rivalNextLevelXP = getXPForNextLevel(gameState.rivalLevel);
            
            if (studentNextLevelXPEl) studentNextLevelXPEl.textContent = `${studentNextLevelXP} XP`;
            if (rivalNextLevelXPEl) rivalNextLevelXPEl.textContent = `${rivalNextLevelXP} XP`;

            // Update XP progress bars
            const studentProgress = getLevelProgress(gameState.studentXP, gameState.studentLevel);
            const rivalProgress = getLevelProgress(gameState.rivalXP, gameState.rivalLevel);
            
            if (studentXPBarEl) studentXPBarEl.style.width = `${studentProgress}%`;
            if (rivalXPBarEl) rivalXPBarEl.style.width = `${rivalProgress}%`;

            // Update rank titles
            if (studentRankTitleEl) studentRankTitleEl.textContent = levelSystem.studentRanks[gameState.studentLevel] || "Unknown Rank";
            if (rivalRankTitleEl) rivalRankTitleEl.textContent = levelSystem.rivalRanks[gameState.rivalLevel] || "Unknown Threat";

            // Update statuses based on level comparison
            const levelDifference = gameState.studentLevel - gameState.rivalLevel;
            
            if (levelDifference >= 3) {
                if (studentStatusEl) studentStatusEl.innerHTML = 'Dominating! üí™';
                if (rivalStatusEl) rivalStatusEl.innerHTML = 'Severely weakened! üò∞';
                if (battlePredictionEl) {
                    battlePredictionEl.innerHTML = "You're crushing it! üèÜ";
                    battlePredictionEl.className = "text-xl font-bold text-green-300";
                }
            } else if (levelDifference >= 1) {
                if (studentStatusEl) studentStatusEl.innerHTML = 'Growing stronger! üí™';
                if (rivalStatusEl) rivalStatusEl.innerHTML = 'Weakening... üòü';
                if (battlePredictionEl) {
                    battlePredictionEl.innerHTML = "You're winning! üèÜ";
                    battlePredictionEl.className = "text-xl font-bold text-green-300";
                }
            } else if (levelDifference <= -3) {
                if (studentStatusEl) studentStatusEl.innerHTML = 'In danger! üò∞';
                if (rivalStatusEl) rivalStatusEl.innerHTML = 'Overpowering! üòà';
                if (battlePredictionEl) {
                    battlePredictionEl.innerHTML = "Rival is winning! ‚ö†Ô∏è";
                    battlePredictionEl.className = "text-xl font-bold text-red-300";
                }
            } else {
                if (studentStatusEl) studentStatusEl.innerHTML = 'Fighting back! ‚öîÔ∏è';
                if (rivalStatusEl) rivalStatusEl.innerHTML = 'Still strong! üò†';
                if (battlePredictionEl) {
                    battlePredictionEl.innerHTML = "Close battle! ‚öîÔ∏è";
                    battlePredictionEl.className = "text-xl font-bold text-yellow-300";
                }
            }

            // Update rival message
            updateRivalMessage();
        }

        // Update rival message based on level comparison
        function updateRivalMessage() {
            const messageEl = document.getElementById('rivalMessage');
            let messageCategory;
            
            const levelDifference = gameState.studentLevel - gameState.rivalLevel;
            
            if (levelDifference >= 2) {
                messageCategory = 'weak';
            } else if (levelDifference <= -2) {
                messageCategory = 'strong';
            } else {
                messageCategory = 'medium';
            }

            const messages = rivalMessages[messageCategory];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            messageEl.textContent = `"${randomMessage}"`;
        }

        // Complete a study task
        function completeTask(taskName, rivalDamage) {
            const studentXPGain = Math.floor(rivalDamage * 2); // Convert damage to XP
            const rivalXPLoss = Math.floor(rivalDamage * 1.5); // Rival loses XP too
            
            gameState.studentXP += studentXPGain;
            gameState.rivalXP = Math.max(0, gameState.rivalXP - rivalXPLoss);
            gameState.tasksCompletedToday++;

            // Show completion modal
            document.getElementById('taskCompletionText').textContent = 
                `You gained ${studentXPGain} XP and your rival lost ${rivalXPLoss} XP!`;
            document.getElementById('taskModal').classList.remove('hidden');

            // Update stats
            document.getElementById('tasksToday').textContent = gameState.tasksCompletedToday;
            
            updatePowerLevels();

            // Show demo reminder if in demo mode
            if (appState.isDemoMode && Math.random() < 0.3) {
                setTimeout(() => {
                    showCustomAlert('Great progress! Sign up to save your achievements and unlock more features! üèÜ');
                }, 2000);
            }
        }

        // Close task completion modal
        function closeTaskModal() {
            document.getElementById('taskModal').classList.add('hidden');
        }

        // Generate custom quiz using AI
        async function generateCustomQuiz() {
            document.getElementById('quizModal').classList.remove('hidden');
            document.getElementById('quizContent').innerHTML = `
                <div class="text-center text-gray-500">
                    <div class="animate-spin inline-block w-8 h-8 border-4 border-current border-t-transparent rounded-full mb-4"></div>
                    <p>Generating quiz questions...</p>
                </div>
            `;

            try {
                // Register handler for quiz generation
                window.Poe.registerHandler("quiz-generator", (result) => {
                    const response = result.responses[0];
                    if (response.status === "complete") {
                        try {
                            const quizData = JSON.parse(response.content);
                            displayQuiz(quizData);
                        } catch (e) {
                            displayQuizError("Failed to parse quiz data. Please try again.");
                        }
                    } else if (response.status === "error") {
                        displayQuizError("Failed to generate quiz. Please try again.");
                    }
                });

                // Request quiz generation
                await window.Poe.sendUserMessage(
                    "@Claude-Sonnet-4 Generate a 3-question multiple choice quiz on a random educational topic suitable for high school students. Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no ```). Format: {\"topic\": \"Topic Name\", \"questions\": [{\"question\": \"Question text\", \"options\": [\"A\", \"B\", \"C\", \"D\"], \"correct\": 0}]}",
                    {
                        handler: "quiz-generator",
                        stream: false,
                        openChat: false
                    }
                );
            } catch (error) {
                displayQuizError("Failed to generate quiz. Please try again.");
            }
        }

        // Display generated quiz
        function displayQuiz(quizData) {
            const quizContent = document.getElementById('quizContent');
            let html = `<h4 class="text-lg font-bold mb-4">Topic: ${quizData.topic}</h4>`;
            
            quizData.questions.forEach((q, qIndex) => {
                html += `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <h5 class="font-medium mb-3">${qIndex + 1}. ${q.question}</h5>
                        <div class="space-y-2">
                            ${q.options.map((option, oIndex) => `
                                <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 p-2 rounded">
                                    <input type="radio" name="q${qIndex}" value="${oIndex}" class="text-primary focus:ring-primary">
                                    <span>${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            quizContent.innerHTML = html;
            document.getElementById('submitQuizBtn').classList.remove('hidden');
            
            // Store quiz data for checking answers
            window.currentQuiz = quizData;
        }

        // Display quiz error
        function displayQuizError(message) {
            document.getElementById('quizContent').innerHTML = `
                <div class="text-center text-red-500">
                    <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                    <p>${message}</p>
                </div>
            `;
        }

        // Submit quiz answers
        function submitQuiz() {
            if (!window.currentQuiz) return;

            let correct = 0;
            const questions = window.currentQuiz.questions;
            
            questions.forEach((q, qIndex) => {
                const selectedAnswer = document.querySelector(`input[name="q${qIndex}"]:checked`);
                if (selectedAnswer && parseInt(selectedAnswer.value) === q.correct) {
                    correct++;
                }
            });

            const damage = correct * 10; // 10 damage per correct answer
            const studentGain = Math.floor(damage * 0.4);
            
            gameState.studentPower = Math.min(100, gameState.studentPower + studentGain);
            gameState.rivalPower = Math.max(0, gameState.rivalPower - damage);
            gameState.tasksCompletedToday++;

            // Show results
            document.getElementById('quizContent').innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">üéØ</div>
                    <h4 class="text-xl font-bold mb-2">Quiz Complete!</h4>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        You got ${correct}/${questions.length} questions correct!
                    </p>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Damage Dealt:</div>
                        <div class="text-2xl font-bold text-rival-red">${damage} points!</div>
                    </div>
                </div>
            `;

            document.getElementById('submitQuizBtn').classList.add('hidden');
            document.getElementById('tasksToday').textContent = gameState.tasksCompletedToday;
            
            updatePowerLevels();
        }

        // Close quiz modal
        function closeQuizModal() {
            document.getElementById('quizModal').classList.add('hidden');
        }

        // Open avatar selection modal
        function openAvatarSelection() {
            document.getElementById('avatarModal').classList.remove('hidden');
            
            // Highlight currently selected avatars
            document.querySelectorAll('.avatar-option').forEach(btn => {
                btn.classList.remove('border-primary', 'bg-gray-200', 'dark:bg-gray-600');
                if (btn.textContent.trim() === selectedStudentAvatar) {
                    btn.classList.add('border-primary', 'bg-gray-200', 'dark:bg-gray-600');
                }
            });
            
            document.querySelectorAll('.rival-avatar-option').forEach(btn => {
                btn.classList.remove('border-rival-red', 'bg-red-50', 'dark:bg-red-900/20');
                if (btn.textContent.trim() === selectedRivalAvatar) {
                    btn.classList.add('border-rival-red', 'bg-red-50', 'dark:bg-red-900/20');
                }
            });
        }

        // Close avatar selection modal
        function closeAvatarModal() {
            document.getElementById('avatarModal').classList.add('hidden');
        }

        // Select student avatar
        function selectAvatar(avatar) {
            selectedStudentAvatar = avatar;
            isCustomAvatar = false;
            
            // Update visual selection
            document.querySelectorAll('.avatar-option').forEach(btn => {
                btn.classList.remove('border-primary', 'bg-gray-200', 'dark:bg-gray-600');
            });
            
            event.target.classList.add('border-primary', 'bg-gray-200', 'dark:bg-gray-600');
        }

        // Select rival avatar
        function selectRivalAvatar(avatar) {
            selectedRivalAvatar = avatar;
            
            // Update visual selection
            document.querySelectorAll('.rival-avatar-option').forEach(btn => {
                btn.classList.remove('border-rival-red', 'bg-red-50', 'dark:bg-red-900/20');
            });
            
            event.target.classList.add('border-rival-red', 'bg-red-50', 'dark:bg-red-900/20');
        }

        // Save avatar selection and update UI
        function saveAvatarSelection() {
            let studentAvatarToUse;
            
            if (isCustomAvatar) {
                studentAvatarToUse = getCustomAvatarString();
            } else {
                studentAvatarToUse = selectedStudentAvatar;
            }
            
            // Update all avatar displays
            document.getElementById('studentAvatar').innerHTML = isCustomAvatar ? 
                `<span>${appState.customAvatar.base}</span><span style="position: absolute; top: -10px; left: -10px;">${appState.customAvatar.hair}</span><span style="position: absolute; top: -10px; right: -10px;">${appState.customAvatar.accessory}</span><span style="position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%);">${appState.customAvatar.aura}</span>` :
                studentAvatarToUse;
            
            document.getElementById('rivalAvatar').textContent = selectedRivalAvatar;
            document.getElementById('headerAvatar').textContent = isCustomAvatar ? appState.customAvatar.base : studentAvatarToUse;
            
            // Close modal
            closeAvatarModal();
            
            // Add a nice confirmation effect
            const studentAvatarEl = document.getElementById('studentAvatar');
            const rivalAvatarEl = document.getElementById('rivalAvatar');
            
            studentAvatarEl.style.transform = 'scale(1.1)';
            rivalAvatarEl.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                studentAvatarEl.style.transform = 'scale(1)';
                rivalAvatarEl.style.transform = 'scale(1)';
            }, 300);

            showCustomAlert('Avatar updated! Your new look is ready for battle! ‚öîÔ∏è');
        }

        // Simulate rival growing stronger over time (when not studying)
        setInterval(() => {
            // Simulate rival gaining power when student is inactive
            if (Math.random() < 0.3) { // 30% chance every interval
                gameState.rivalPower = Math.min(100, gameState.rivalPower + 1);
                updatePowerLevels();
            }
        }, 30000); // Every 30 seconds

        // Update battle countdown
        function updateBattleCountdown() {
            const now = new Date();
            const nextBattle = new Date();
            nextBattle.setDate(nextBattle.getDate() + (7 - nextBattle.getDay())); // Next Sunday
            nextBattle.setHours(0, 0, 0, 0);
            
            const diff = nextBattle - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            document.getElementById('battleCountdown').textContent = `${days}d ${hours}h`;
        }

        // Battlefield quiz data
        const battlefieldQuizzes = {
            algebra: {
                name: "Algebra Test Prep",
                questions: [
                    {
                        question: "What is the solution to the equation: 2x + 5 = 13?",
                        options: ["x = 4", "x = 6", "x = 8", "x = 9"],
                        correct: 0
                    },
                    {
                        question: "Which is the vertex form of a quadratic equation?",
                        options: ["y = ax¬≤ + bx + c", "y = a(x - h)¬≤ + k", "y = mx + b", "y = ax + b"],
                        correct: 1
                    },
                    {
                        question: "If f(x) = x¬≤ - 4x + 3, what is f(2)?",
                        options: ["-1", "0", "1", "3"],
                        correct: 0
                    },
                    {
                        question: "What are the roots of x¬≤ - 5x + 6 = 0?",
                        options: ["x = 1, x = 6", "x = 2, x = 3", "x = -2, x = -3", "x = 1, x = 5"],
                        correct: 1
                    }
                ]
            },
            chemistry: {
                name: "Chemistry Test Review",
                questions: [
                    {
                        question: "What is the atomic number of Carbon?",
                        options: ["4", "6", "8", "12"],
                        correct: 1
                    },
                    {
                        question: "Which type of bond forms between Na and Cl?",
                        options: ["Covalent", "Metallic", "Ionic", "Hydrogen"],
                        correct: 2
                    },
                    {
                        question: "What is the pH of a neutral solution?",
                        options: ["0", "1", "7", "14"],
                        correct: 2
                    },
                    {
                        question: "How many electrons can the second shell hold?",
                        options: ["2", "6", "8", "18"],
                        correct: 2
                    }
                ]
            },
            history: {
                name: "History Exam Prep",
                questions: [
                    {
                        question: "In which year did World War II begin?",
                        options: ["1938", "1939", "1940", "1941"],
                        correct: 1
                    },
                    {
                        question: "Who was the leader of Nazi Germany?",
                        options: ["Mussolini", "Stalin", "Hitler", "Churchill"],
                        correct: 2
                    },
                    {
                        question: "Which event brought the US into WWII?",
                        options: ["Pearl Harbor", "D-Day", "Holocaust", "Berlin Wall"],
                        correct: 0
                    },
                    {
                        question: "When did WWII end in Europe?",
                        options: ["May 1944", "May 1945", "August 1945", "September 1945"],
                        correct: 1
                    }
                ]
            }
        };

        // Current battlefield state
        let currentBattlefield = {
            taskId: '',
            subject: '',
            currentQuestion: 0,
            score: 0,
            studentBattleXP: 0,
            rivalBattleXP: 0,
            studentBattleLevel: 0,
            rivalBattleLevel: 0
        };

        // Teacher assignment battlefield functionality
        function enterBattlefield(taskId, taskName, subject) {
            // Show dramatic battlefield entry
            showCustomAlert(`‚öîÔ∏è Entering battlefield for: ${taskName}! Prepare for battle!`);
            
            // Reset and initialize battlefield state completely
            currentBattlefield = {
                taskId: taskId,
                subject: subject,
                currentQuestion: 0,
                score: 0,
                studentBattleXP: gameState.studentXP,
                rivalBattleXP: gameState.rivalXP,
                studentBattleLevel: gameState.studentLevel,
                rivalBattleLevel: gameState.rivalLevel
            };
            
            // Clear any previous battlefield content
            document.getElementById('battleQuestionContent').innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">‚öîÔ∏è</div>
                    <h3 class="text-2xl font-bold mb-4">Ready for Battle?</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">Answer questions correctly to damage your rival!</p>
                    <button onclick="startBattleQuiz()" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium text-lg">
                        ‚öîÔ∏è Begin Battle!
                    </button>
                </div>
            `;
            
            // Open battlefield interface
            openBattlefieldInterface(taskName, subject);
        }

        function completeTeacherTask(taskId, taskName, damage) {
            const studentGain = Math.floor(damage * 0.4); // Teacher tasks give more power
            
            gameState.studentPower = Math.min(100, gameState.studentPower + studentGain);
            gameState.rivalPower = Math.max(0, gameState.rivalPower - damage);
            gameState.tasksCompletedToday++;

            // Mark task as completed
            const taskElement = document.getElementById(taskId);
            const button = taskElement.querySelector('button');
            button.innerHTML = '<span>‚úÖ</span><span>Completed!</span>';
            button.className = 'w-full mt-4 bg-green-500 text-white py-2 rounded-lg font-medium flex items-center justify-center space-x-2';
            
            // Add completion badge
            taskElement.style.opacity = '0.7';
            taskElement.style.background = 'linear-gradient(to right, #d4ffd4, #c3f0c3)';

            // Show completion modal with special effects
            document.getElementById('taskCompletionText').innerHTML = 
                `<strong>MASSIVE VICTORY!</strong><br>You dealt ${damage} damage to your rival with "${taskName}"!<br><span class="text-sm text-green-600 mt-2 block">Teacher assignments deal extra damage! üí•</span>`;
            document.getElementById('taskModal').classList.remove('hidden');

            // Update stats
            document.getElementById('tasksToday').textContent = gameState.tasksCompletedToday;
            
            updatePowerLevels();
            updateLearningTips();

            showCustomAlert(`üèÜ ${taskName} conquered! Your rival trembles before your academic might!`);
        }

        // Update learning tips based on performance
        function updateLearningTips() {
            // This would normally analyze real performance data
            // For demo, we'll show dynamic tips based on current state
            
            if (gameState.studentPower > 80) {
                showCustomAlert('üí° Pro tip: You\'re on fire! Keep this momentum going with challenging topics!');
            } else if (gameState.rivalPower > gameState.studentPower) {
                showCustomAlert('üí° AI Coach: Focus on your weak areas to turn this battle around!');
            }
        }

        // Open battlefield interface
        function openBattlefieldInterface(taskName, subject) {
            // Set battlefield title
            document.getElementById('battlefieldTitle').textContent = `‚öîÔ∏è ${taskName} Battle`;
            
            // Initialize battle power displays (now using levels and showing progress)
            document.getElementById('battleStudentPower').textContent = `Level ${currentBattlefield.studentBattleLevel}`;
            document.getElementById('battleRivalPower').textContent = `Level ${currentBattlefield.rivalBattleLevel}`;
            
            // Show level progress as bars (0-100% based on XP progress within level)
            const studentProgress = getLevelProgress(currentBattlefield.studentBattleXP, currentBattlefield.studentBattleLevel);
            const rivalProgress = getLevelProgress(currentBattlefield.rivalBattleXP, currentBattlefield.rivalBattleLevel);
            
            document.getElementById('battleStudentBar').style.width = `${studentProgress}%`;
            document.getElementById('battleRivalBar').style.width = `${rivalProgress}%`;
            
            // Set question progress
            const totalQuestions = battlefieldQuizzes[subject].questions.length;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('currentQuestionNum').textContent = '1';
            document.getElementById('questionProgress').style.width = '0%';
            
            // Show battlefield modal
            document.getElementById('battlefieldModal').classList.remove('hidden');
        }

        // Start the battle quiz
        function startBattleQuiz() {
            showBattleQuestion();
        }

        // Show current battle question
        function showBattleQuestion() {
            const quiz = battlefieldQuizzes[currentBattlefield.subject];
            if (!quiz) {
                console.error('Quiz not found for subject:', currentBattlefield.subject);
                return;
            }
            const question = quiz.questions[currentBattlefield.currentQuestion];
            const questionNum = currentBattlefield.currentQuestion + 1;
            const totalQuestions = quiz.questions.length;
            
            // Update progress
            document.getElementById('currentQuestionNum').textContent = questionNum;
            const progressPercent = ((questionNum - 1) / totalQuestions) * 100;
            document.getElementById('questionProgress').style.width = `${progressPercent}%`;
            
            // Generate question HTML
            const questionHTML = `
                <div class="text-center mb-6">
                    <div class="text-4xl mb-4">‚öîÔ∏è</div>
                    <h3 class="text-xl font-bold mb-2">Question ${questionNum} of ${totalQuestions}</h3>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Answer correctly to damage your rival!</div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 mb-6">
                    <h4 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">${question.question}</h4>
                    <div class="space-y-3">
                        ${question.options.map((option, index) => `
                            <button onclick="selectBattleAnswer(${index})" 
                                    class="battle-option w-full text-left p-4 rounded-lg border border-gray-300 dark:border-gray-600 hover:border-primary hover:bg-primary/5 transition-all duration-200 text-gray-800 dark:text-gray-200">
                                <div class="flex items-center space-x-3">
                                    <div class="w-6 h-6 rounded-full border-2 border-gray-400 flex items-center justify-center text-sm font-bold">
                                        ${String.fromCharCode(65 + index)}
                                    </div>
                                    <span>${option}</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
                
                <div class="text-center">
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-4">Choose your answer to attack!</div>
                </div>
            `;
            
            document.getElementById('battleQuestionContent').innerHTML = questionHTML;
        }

        // Select battle answer
        function selectBattleAnswer(answerIndex) {
            const quiz = battlefieldQuizzes[currentBattlefield.subject];
            const question = quiz.questions[currentBattlefield.currentQuestion];
            const isCorrect = answerIndex === question.correct;
            
            // Highlight selected answer
            const options = document.querySelectorAll('.battle-option');
            options.forEach((option, index) => {
                option.style.pointerEvents = 'none';
                if (index === answerIndex) {
                    option.className = isCorrect ? 
                        'battle-option w-full text-left p-4 rounded-lg border-2 border-green-500 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' :
                        'battle-option w-full text-left p-4 rounded-lg border-2 border-red-500 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200';
                } else if (index === question.correct) {
                    option.className = 'battle-option w-full text-left p-4 rounded-lg border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300';
                }
            });
            
            // Show battle result
            setTimeout(() => {
                processBattleAnswer(isCorrect);
            }, 2000);
        }

        // Process battle answer and show effects
        function processBattleAnswer(isCorrect) {
            if (isCorrect) {
                // Correct answer - student gains XP, rival loses XP
                const xpGain = 30;
                const rivalXPLoss = 20;
                currentBattlefield.studentBattleXP += xpGain;
                currentBattlefield.rivalBattleXP = Math.max(0, currentBattlefield.rivalBattleXP - rivalXPLoss);
                currentBattlefield.score++;
                
                // Update levels based on new XP
                currentBattlefield.studentBattleLevel = getXPLevel(currentBattlefield.studentBattleXP);
                currentBattlefield.rivalBattleLevel = getXPLevel(currentBattlefield.rivalBattleXP);
                
                showBattleEffect("üí• DIRECT HIT!", `You gained ${xpGain} XP! Rival lost ${rivalXPLoss} XP!`, 'success');
            } else {
                // Wrong answer - rival gains XP
                const rivalXPGain = 15;
                currentBattlefield.rivalBattleXP += rivalXPGain;
                currentBattlefield.rivalBattleLevel = getXPLevel(currentBattlefield.rivalBattleXP);
                
                showBattleEffect("üòà RIVAL STRIKES!", `Your rival gained ${rivalXPGain} XP!`, 'error');
            }
            
            // Update battle power displays with levels and progress bars
            document.getElementById('battleStudentPower').textContent = `Level ${currentBattlefield.studentBattleLevel}`;
            document.getElementById('battleRivalPower').textContent = `Level ${currentBattlefield.rivalBattleLevel}`;
            
            // Update progress bars based on XP progress within levels
            const studentProgress = getLevelProgress(currentBattlefield.studentBattleXP, currentBattlefield.studentBattleLevel);
            const rivalProgress = getLevelProgress(currentBattlefield.rivalBattleXP, currentBattlefield.rivalBattleLevel);
            
            document.getElementById('battleStudentBar').style.width = `${studentProgress}%`;
            document.getElementById('battleRivalBar').style.width = `${rivalProgress}%`;
            
            // Move to next question or end battle
            setTimeout(() => {
                currentBattlefield.currentQuestion++;
                if (currentBattlefield.currentQuestion < battlefieldQuizzes[currentBattlefield.subject].questions.length) {
                    showBattleQuestion();
                } else {
                    endBattle();
                }
            }, 3000);
        }

        // Show battle effect
        function showBattleEffect(title, message, type) {
            const effectColor = type === 'success' ? 'text-green-300' : 'text-red-300';
            const effectHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">${type === 'success' ? 'üí•' : 'üòà'}</div>
                    <h3 class="text-2xl font-bold mb-2 ${effectColor}">${title}</h3>
                    <p class="text-lg text-gray-600 dark:text-gray-400 mb-4">${message}</p>
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        ${currentBattlefield.currentQuestion + 1 < battlefieldQuizzes[currentBattlefield.subject].questions.length ? 
                          'Preparing next question...' : 'Calculating final results...'}
                    </div>
                </div>
            `;
            document.getElementById('battleQuestionContent').innerHTML = effectHTML;
        }

        // End battle and show results
        function endBattle() {
            const totalQuestions = battlefieldQuizzes[currentBattlefield.subject].questions.length;
            const percentage = Math.round((currentBattlefield.score / totalQuestions) * 100);
            const finalDamage = currentBattlefield.score * 15; // 15 damage per correct answer
            
            // Update main game state
            gameState.studentPower = currentBattlefield.studentBattlePower;
            gameState.rivalPower = currentBattlefield.rivalBattlePower;
            gameState.tasksCompletedToday++;
            
            // Determine victory status
            let victoryStatus, victoryMessage, victoryClass;
            if (percentage >= 75) {
                victoryStatus = "üèÜ CRUSHING VICTORY!";
                victoryMessage = "Your rival cowers before your academic might!";
                victoryClass = "text-yellow-400";
            } else if (percentage >= 50) {
                victoryStatus = "‚öîÔ∏è SOLID WIN!";
                victoryMessage = "You've dealt significant damage to your rival!";
                victoryClass = "text-green-400";
            } else {
                victoryStatus = "üò§ TOUGH BATTLE!";
                victoryMessage = "Your rival grows stronger, but you're not giving up!";
                victoryClass = "text-orange-400";
            }
            
            // Show final battle results
            const resultsHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">üèÅ</div>
                    <h3 class="text-3xl font-bold mb-2 ${victoryClass}">${victoryStatus}</h3>
                    <p class="text-lg text-gray-600 dark:text-gray-400 mb-6">${victoryMessage}</p>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Accuracy</div>
                            <div class="text-2xl font-bold text-blue-500">${percentage}%</div>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                            <div class="text-sm text-gray-600 dark:text-gray-400">Score</div>
                            <div class="text-2xl font-bold text-green-500">${currentBattlefield.score}/${totalQuestions}</div>
                        </div>
                    </div>
                    
                    <div class="bg-primary/10 border border-primary/20 rounded-lg p-4 mb-6">
                        <div class="text-sm text-primary font-medium mb-2">Total Damage Dealt</div>
                        <div class="text-3xl font-bold text-primary">${finalDamage} points!</div>
                    </div>
                    
                    <button onclick="exitBattlefield()" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium text-lg">
                        Return to Base ‚öîÔ∏è
                    </button>
                </div>
            `;
            
            document.getElementById('battleQuestionContent').innerHTML = resultsHTML;
            
            // Update progress bars one final time
            document.getElementById('questionProgress').style.width = '100%';
            
            // Mark task as completed
            setTimeout(() => {
                completeTeacherTask(currentBattlefield.taskId, battlefieldQuizzes[currentBattlefield.subject].name, finalDamage);
            }, 1000);
        }

        // Exit battlefield
        function exitBattlefield() {
            document.getElementById('battlefieldModal').classList.add('hidden');
            updatePowerLevels(); // Update main UI
        }

        // Practice task question banks
        const practiceQuizzes = {
            math: {
                name: "Math Practice",
                damage: 15,
                questions: [
                    {
                        question: "What is 15% of 80?",
                        options: ["10", "12", "15", "20"],
                        correct: 1
                    },
                    {
                        question: "Solve: 3x - 7 = 14",
                        options: ["x = 5", "x = 7", "x = 9", "x = 11"],
                        correct: 1
                    },
                    {
                        question: "What is the area of a circle with radius 4?",
                        options: ["12œÄ", "16œÄ", "20œÄ", "24œÄ"],
                        correct: 1
                    }
                ]
            },
            science: {
                name: "Science Quiz",
                damage: 20,
                questions: [
                    {
                        question: "What is the chemical symbol for gold?",
                        options: ["Go", "Gd", "Au", "Ag"],
                        correct: 2
                    },
                    {
                        question: "Which planet is closest to the Sun?",
                        options: ["Venus", "Mercury", "Earth", "Mars"],
                        correct: 1
                    },
                    {
                        question: "What gas do plants absorb during photosynthesis?",
                        options: ["Oxygen", "Nitrogen", "Carbon dioxide", "Hydrogen"],
                        correct: 2
                    }
                ]
            },
            reading: {
                name: "Reading Comprehension",
                damage: 10,
                questions: [
                    {
                        question: "Read: 'The cat sat on the mat.' What is the subject?",
                        options: ["sat", "mat", "cat", "on"],
                        correct: 2
                    },
                    {
                        question: "Which is a synonym for 'happy'?",
                        options: ["sad", "joyful", "angry", "tired"],
                        correct: 1
                    },
                    {
                        question: "What type of text tells a story?",
                        options: ["Informative", "Persuasive", "Narrative", "Descriptive"],
                        correct: 2
                    }
                ]
            }
        };

        // Current practice task state
        let currentPracticeTask = {
            subject: '',
            currentQuestion: 0,
            score: 0,
            totalQuestions: 0
        };

        // Start practice task
        function startPracticeTask(subject) {
            const quiz = practiceQuizzes[subject];
            if (!quiz) {
                showCustomAlert('Practice task not found!');
                return;
            }

            // Initialize practice task state
            currentPracticeTask = {
                subject: subject,
                currentQuestion: 0,
                score: 0,
                totalQuestions: quiz.questions.length
            };

            // Show practice task modal using the existing quiz modal
            document.getElementById('quizModal').classList.remove('hidden');
            document.querySelector('#quizModal h3').textContent = `‚öîÔ∏è ${quiz.name}`;
            document.querySelector('#quizModal p').textContent = `Quick practice to damage your rival!`;
            
            // Start showing questions
            showPracticeQuestion();
        }

        // Show current practice question
        function showPracticeQuestion() {
            const quiz = practiceQuizzes[currentPracticeTask.subject];
            const question = quiz.questions[currentPracticeTask.currentQuestion];
            const questionNum = currentPracticeTask.currentQuestion + 1;
            
            const questionHTML = `
                <div class="text-center mb-4">
                    <div class="text-2xl mb-2">üìö</div>
                    <h4 class="text-lg font-bold">Question ${questionNum} of ${currentPracticeTask.totalQuestions}</h4>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-4">
                    <h5 class="font-medium mb-3">${question.question}</h5>
                    <div class="space-y-2">
                        ${question.options.map((option, oIndex) => `
                            <button onclick="selectPracticeAnswer(${oIndex})" class="practice-option w-full text-left p-3 rounded hover:bg-gray-100 dark:hover:bg-gray-600 border border-gray-300 dark:border-gray-600 transition-colors">
                                <div class="flex items-center space-x-3">
                                    <div class="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center text-sm font-bold">
                                        ${String.fromCharCode(65 + oIndex)}
                                    </div>
                                    <span>${option}</span>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('quizContent').innerHTML = questionHTML;
            document.getElementById('submitQuizBtn').classList.add('hidden');
        }

        // Select practice answer
        function selectPracticeAnswer(answerIndex) {
            const quiz = practiceQuizzes[currentPracticeTask.subject];
            const question = quiz.questions[currentPracticeTask.currentQuestion];
            const isCorrect = answerIndex === question.correct;
            
            if (isCorrect) {
                currentPracticeTask.score++;
            }

            // Highlight selected answer
            const options = document.querySelectorAll('.practice-option');
            options.forEach((option, index) => {
                option.style.pointerEvents = 'none';
                if (index === answerIndex) {
                    option.className = isCorrect ? 
                        'practice-option w-full text-left p-3 rounded border-2 border-green-500 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200' :
                        'practice-option w-full text-left p-3 rounded border-2 border-red-500 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200';
                } else if (index === question.correct) {
                    option.className = 'practice-option w-full text-left p-3 rounded border-2 border-green-500 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300';
                }
            });

            // Move to next question or show results
            setTimeout(() => {
                currentPracticeTask.currentQuestion++;
                if (currentPracticeTask.currentQuestion < currentPracticeTask.totalQuestions) {
                    showPracticeQuestion();
                } else {
                    showPracticeResults();
                }
            }, 1500);
        }

        // Show practice results
        function showPracticeResults() {
            const quiz = practiceQuizzes[currentPracticeTask.subject];
            const percentage = Math.round((currentPracticeTask.score / currentPracticeTask.totalQuestions) * 100);
            const damage = Math.floor((currentPracticeTask.score / currentPracticeTask.totalQuestions) * quiz.damage);
            const studentGain = Math.floor(damage * 0.3);
            
            // Update game state
            gameState.studentPower = Math.min(100, gameState.studentPower + studentGain);
            gameState.rivalPower = Math.max(0, gameState.rivalPower - damage);
            gameState.tasksCompletedToday++;

            // Show results
            document.getElementById('quizContent').innerHTML = `
                <div class="text-center">
                    <div class="text-6xl mb-4">‚öîÔ∏è</div>
                    <h4 class="text-xl font-bold mb-2">${quiz.name} Complete!</h4>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        You got ${currentPracticeTask.score}/${currentPracticeTask.totalQuestions} questions correct! (${percentage}%)
                    </p>
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-2">Damage Dealt:</div>
                        <div class="text-2xl font-bold text-rival-red">${damage} points!</div>
                    </div>
                    <div class="bg-primary/10 border border-primary/20 rounded-lg p-3">
                        <div class="text-sm text-primary font-medium">Power Changes:</div>
                        <div class="flex justify-between mt-1">
                            <span class="text-student-blue">You: +${studentGain}</span>
                            <span class="text-rival-red">Rival: -${damage}</span>
                        </div>
                    </div>
                </div>
            `;

            // Update UI
            document.getElementById('tasksToday').textContent = gameState.tasksCompletedToday;
            updatePowerLevels();

            // Show encouraging message
            if (percentage >= 75) {
                showCustomAlert('üèÜ Excellent work! Your rival is trembling!');
            } else if (percentage >= 50) {
                showCustomAlert('üí™ Good job! Keep fighting the good fight!');
            } else {
                showCustomAlert('üìö Keep practicing! Every effort weakens your rival!');
            }

            // Hide submit button, show close as only option
            document.getElementById('submitQuizBtn').classList.add('hidden');
        }

        // Teacher mode functionality
        function enterTeacherMode() {
            // Hide welcome screen and show teacher dashboard
            document.getElementById('welcomeScreen').classList.add('hidden');
            showTeacherDashboard();
        }

        // Show teacher dashboard
        function showTeacherDashboard() {
            // COMPLETELY HIDE the entire student interface
            const elementsToHide = [
                'header',
                '.max-w-6xl',
                'footer',
                '.battle-arena',
                '.grid.md\\:grid-cols-3.gap-8'
            ];
            
            elementsToHide.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el) {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        el.style.height = '0';
                        el.style.overflow = 'hidden';
                    }
                });
            });
            
            // Create teacher dashboard
            const teacherDashboard = document.createElement('div');
            teacherDashboard.id = 'teacherDashboard';
            teacherDashboard.className = 'min-h-screen bg-gradient-to-br from-purple-50 to-indigo-100 dark:from-purple-900/20 dark:to-indigo-900/20';
            teacherDashboard.innerHTML = `
                <!-- Teacher Header -->
                <header class="bg-white dark:bg-gray-800 shadow-lg border-b border-gray-200 dark:border-gray-700">
                    <div class="max-w-6xl mx-auto px-4 py-4">
                        <div class="flex items-center justify-between min-h-[48px]">
                            <div class="flex items-center space-x-3">
                                <img src="https://pfst.cf2.poecdn.net/base/image/d8a0c0161f0dc8666c5197238093e8d8c7a3a51380a4b3b77a77a94a34f8628a?w=2191&h=634" alt="Rival You Logo" class="h-10 w-auto rounded-lg">
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-600 dark:text-gray-400">Welcome, Demo Teacher!</span>
                                <button onclick="toggleTeacherMode()" class="bg-green-600 text-white hover:bg-green-700 px-2 md:px-4 py-2 rounded-lg transition-colors font-medium text-sm whitespace-nowrap">
                                    <span class="hidden md:inline">üë®‚Äçüéì Student Mode</span>
                                    <span class="md:hidden">üë®‚Äçüéì</span>
                                </button>
                                <button onclick="exitTeacherMode(); showWelcomeScreen();" class="bg-blue-600 text-white hover:bg-blue-700 px-2 md:px-4 py-2 rounded-lg transition-colors font-medium text-sm whitespace-nowrap">
                                    <span class="hidden md:inline">‚Üê Back to Sign Up</span>
                                    <span class="md:hidden">‚Üê Sign Up</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <div class="max-w-6xl mx-auto px-4 py-6 space-y-8">
                    <!-- Quick Stats -->
                    <div class="grid md:grid-cols-4 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="text-3xl mr-3">üìö</div>
                                <div>
                                    <div class="text-2xl font-bold text-blue-600">12</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Active Assignments</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="text-3xl mr-3">üë•</div>
                                <div>
                                    <div class="text-2xl font-bold text-green-600">28</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Students</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="text-3xl mr-3">‚öîÔ∏è</div>
                                <div>
                                    <div class="text-2xl font-bold text-yellow-600">156</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Battles Completed</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <div class="flex items-center">
                                <div class="text-3xl mr-3">üìä</div>
                                <div>
                                    <div class="text-2xl font-bold text-purple-600">87%</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Avg Completion</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Actions -->
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Create Assignment -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                ‚öîÔ∏è Create New Battle Assignment
                                <span class="ml-2 text-sm bg-purple-500 text-white px-2 py-1 rounded-full">New</span>
                            </h3>
                            
                            <form id="assignmentForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Assignment Title</label>
                                    <input type="text" id="assignmentTitle" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="e.g., Algebra Quiz Battle">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Subject</label>
                                    <select id="assignmentSubject" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="algebra">Algebra</option>
                                        <option value="chemistry">Chemistry</option>
                                        <option value="history">History</option>
                                        <option value="english">English</option>
                                        <option value="physics">Physics</option>
                                        <option value="biology">Biology</option>
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description</label>
                                    <textarea id="assignmentDescription" rows="3" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Describe what students will practice..."></textarea>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Due Date</label>
                                        <input type="date" id="assignmentDueDate" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Question Count</label>
                                        <select id="assignmentQuestionCount" class="w-full px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="5">5 Questions</option>
                                            <option value="8" selected>8 Questions</option>
                                            <option value="10">10 Questions</option>
                                            <option value="12">12 Questions</option>
                                            <option value="15">15 Questions</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <button type="button" onclick="createAssignment()" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                    ‚öîÔ∏è Create Assignment Questions
                                </button>
                            </form>
                        </div>

                        <!-- Active Assignments -->
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold mb-4 flex items-center">
                                üìã Active Battle Assignments
                                <span class="ml-2 text-sm bg-green-500 text-white px-2 py-1 rounded-full">Live</span>
                            </h3>
                            
                            <div id="activeAssignments" class="space-y-3 max-h-96 overflow-y-auto">
                                <!-- Demo assignments - now clickable -->
                                <div onclick="showTeacherAssignmentDetails('algebra-prep')" class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-yellow-700 dark:text-yellow-400">Algebra Test Prep</h4>
                                        <span class="text-xs bg-yellow-100 dark:bg-yellow-900/50 text-yellow-700 dark:text-yellow-300 px-2 py-1 rounded">Math</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Quadratic equations, graphing, word problems</p>
                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                        <span>Due: Friday</span>
                                        <span>18/28 completed ‚Ä¢ <span class="text-blue-600">Click for details</span></span>
                                    </div>
                                </div>
                                
                                <div onclick="showTeacherAssignmentDetails('chemistry-review')" class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-blue-700 dark:text-blue-400">Chemistry Test Review</h4>
                                        <span class="text-xs bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">Science</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">Periodic table, chemical bonds, reactions</p>
                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                        <span>Due: Monday</span>
                                        <span>12/28 completed ‚Ä¢ <span class="text-blue-600">Click for details</span></span>
                                    </div>
                                </div>
                                
                                <div onclick="showTeacherAssignmentDetails('history-exam')" class="border border-gray-200 dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-green-700 dark:text-green-400">History Exam Prep</h4>
                                        <span class="text-xs bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 px-2 py-1 rounded">History</span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">World War II, causes and consequences</p>
                                    <div class="flex justify-between items-center text-xs text-gray-500">
                                        <span>Due: In 2 weeks</span>
                                        <span>8/28 completed ‚Ä¢ <span class="text-blue-600">Click for details</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rhino AI Controls -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            ü¶è Rhino AI Tutor Controls
                            <span class="ml-2 text-sm bg-purple-500 text-white px-2 py-1 rounded-full">Classroom Management</span>
                        </h3>
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            <!-- Manual Control -->
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-800 dark:text-gray-200">Manual Control</h4>
                                
                                <div onclick="toggleRhinoChatTeacher()" class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer transition-colors">
                                    <div>
                                        <div class="font-medium">Rhino Chat Status</div>
                                        <div class="text-sm text-gray-600 dark:text-gray-400" id="rhinoStatusText">Currently enabled for all students</div>
                                    </div>
                                    <button id="rhinoToggleBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm font-medium pointer-events-none">
                                        üü¢ Enabled
                                    </button>
                                </div>
                                
                                <div class="text-xs text-gray-500 dark:text-gray-400">
                                    üí° <strong>Tip:</strong> Disable during lessons, enable during practice time
                                </div>
                            </div>
                            
                            <!-- Time-Based Control -->
                            <div class="space-y-4">
                                <h4 class="font-semibold text-gray-800 dark:text-gray-200">Schedule Auto-Lock</h4>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-3">
                                        <input type="checkbox" id="enableScheduleLock" onchange="toggleScheduleLock()" class="rounded text-purple-600 focus:ring-purple-500">
                                        <label for="enableScheduleLock" class="text-sm font-medium">Enable automatic locking during specific hours</label>
                                    </div>
                                    
                                    <div id="scheduleControls" class="space-y-3 opacity-50">
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Lock From</label>
                                                <input type="time" id="lockStartTime" value="09:00" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateScheduleLock()" disabled>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Lock Until</label>
                                                <input type="time" id="lockEndTime" value="11:00" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded focus:ring-2 focus:ring-purple-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onchange="updateScheduleLock()" disabled>
                                            </div>
                                        </div>
                                        
                                        <div class="text-xs text-gray-500 dark:text-gray-400" id="scheduleStatus">
                                            ‚è∏Ô∏è Automatic locking disabled
                                        </div>
                                        
                                        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-600 rounded p-2 text-xs">
                                            <div class="text-blue-700 dark:text-blue-300">
                                                <strong>üí° Smart Tip:</strong> Enable during lesson periods (e.g., 9:00-11:00 AM) to prevent distractions, then students can access Rhino during breaks and study time.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Current Status Display -->
                        <div class="mt-6 p-4 border border-gray-200 dark:border-gray-600 rounded-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-medium text-gray-800 dark:text-gray-200">Current Student View</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400" id="studentViewStatus">Students can currently access Rhino AI tutor</div>
                                </div>
                                <div id="studentViewIcon" class="text-2xl">ü¶è</div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Progress -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold mb-4 flex items-center">
                            üë• Student Battle Progress
                            <span class="ml-2 text-sm bg-blue-500 text-white px-2 py-1 rounded-full">Live Tracking</span>
                        </h3>
                        
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="border-b border-gray-200 dark:border-gray-600">
                                        <th class="text-left py-3 px-4">Student</th>
                                        <th class="text-left py-3 px-4">Level & XP</th>
                                        <th class="text-left py-3 px-4">Assignments</th>
                                        <th class="text-left py-3 px-4">Streak</th>
                                        <th class="text-left py-3 px-4">Last Active</th>
                                    </tr>
                                </thead>
                                <tbody id="studentProgress">
                                    <tr class="border-b border-gray-100 dark:border-gray-700">
                                        <td class="py-3 px-4">
                                            <div class="flex items-center">
                                                <span class="text-lg mr-2">üß†</span>
                                                <div>
                                                    <div class="font-medium">Alex Johnson</div>
                                                    <div class="text-xs text-green-600 font-semibold">Brain Champion</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <div class="flex items-center">
                                                <div class="mr-3">
                                                    <div class="flex items-center mb-1">
                                                        <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">6</div>
                                                        <span class="text-sm font-semibold">1,420 XP</span>
                                                    </div>
                                                    <div class="w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                                        <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full" style="width: 15%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-green-600 font-semibold">8/10</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-yellow-600 font-semibold">7 days üî•</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-gray-600 dark:text-gray-400">2 min ago</span>
                                        </td>
                                    </tr>
                                    
                                    <tr class="border-b border-gray-100 dark:border-gray-700">
                                        <td class="py-3 px-4">
                                            <div class="flex items-center">
                                                <span class="text-lg mr-2">üòé</span>
                                                <div>
                                                    <div class="font-medium">Emma Davis</div>
                                                    <div class="text-xs text-blue-600 font-semibold">Academic Fighter</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <div class="flex items-center">
                                                <div class="mr-3">
                                                    <div class="flex items-center mb-1">
                                                        <div class="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">5</div>
                                                        <span class="text-sm font-semibold">1,180 XP</span>
                                                    </div>
                                                    <div class="w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                                        <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full" style="width: 45%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-yellow-600 font-semibold">6/10</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-green-600 font-semibold">3 days</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-gray-600 dark:text-gray-400">1 hour ago</span>
                                        </td>
                                    </tr>
                                    
                                    <tr class="border-b border-gray-100 dark:border-gray-700">
                                        <td class="py-3 px-4">
                                            <div class="flex items-center">
                                                <span class="text-lg mr-2">ü§ì</span>
                                                <div>
                                                    <div class="font-medium">Michael Chen</div>
                                                    <div class="text-xs text-orange-600 font-semibold">Study Warrior</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <div class="flex items-center">
                                                <div class="mr-3">
                                                    <div class="flex items-center mb-1">
                                                        <div class="w-6 h-6 bg-orange-500 text-white rounded-full flex items-center justify-center text-xs font-bold mr-2">3</div>
                                                        <span class="text-sm font-semibold">520 XP</span>
                                                    </div>
                                                    <div class="w-20 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                                        <div class="bg-gradient-to-r from-orange-400 to-orange-600 h-2 rounded-full" style="width: 28%"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-red-600 font-semibold">3/10</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-gray-600">1 day</span>
                                        </td>
                                        <td class="py-3 px-4">
                                            <span class="text-gray-600 dark:text-gray-400">2 days ago</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Teacher Assignment Details Modal -->
                <div id="teacherAssignmentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden" style="z-index: 10000;">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <div class="p-8">
                            <div class="flex items-center justify-between mb-6">
                                <div>
                                    <h3 id="teacherDetailsAssignmentTitle" class="text-3xl font-bold mb-2 text-purple-600">Algebra Test Prep</h3>
                                    <p id="teacherDetailsAssignmentSubject" class="text-gray-600 dark:text-gray-400">Mathematics ‚Ä¢ Due Friday</p>
                                </div>
                                <button onclick="closeTeacherAssignmentDetails()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-xl">‚úï</button>
                            </div>

                            <!-- Assignment Stats -->
                            <div class="grid md:grid-cols-4 gap-6 mb-8">
                                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-blue-600" id="teacherDetailsCompletionRate">64%</div>
                                    <div class="text-sm text-blue-700 dark:text-blue-300">Completion Rate</div>
                                </div>
                                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-green-600" id="teacherDetailsAvgScore">78%</div>
                                    <div class="text-sm text-green-700 dark:text-green-300">Average Score</div>
                                </div>
                                <div class="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-yellow-600" id="teacherDetailsBattlesWon">14</div>
                                    <div class="text-sm text-yellow-700 dark:text-yellow-300">Battles Won</div>
                                </div>
                                <div class="bg-purple-50 dark:bg-purple-900/20 rounded-lg p-4">
                                    <div class="text-2xl font-bold text-purple-600" id="teacherDetailsAvgTime">4.2m</div>
                                    <div class="text-sm text-purple-700 dark:text-purple-300">Avg Time</div>
                                </div>
                            </div>

                            <!-- Student Results Table -->
                            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                    <h4 class="text-lg font-semibold">üìä Individual Student Results</h4>
                                </div>
                                
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th class="text-left py-3 px-6">Student</th>
                                                <th class="text-left py-3 px-6">Status</th>
                                                <th class="text-left py-3 px-6">Score</th>
                                                <th class="text-left py-3 px-6">Time Taken</th>
                                                <th class="text-left py-3 px-6">XP Gained</th>
                                                <th class="text-left py-3 px-6">Attempts</th>
                                                <th class="text-left py-3 px-6">Battle Result</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teacherStudentResultsTable">
                                            <!-- Student results will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Question Performance Analysis -->
                            <div class="mt-8 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
                                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                    <h4 class="text-lg font-semibold">üéØ Question Performance Analysis</h4>
                                </div>
                                
                                <div class="p-6">
                                    <div id="teacherQuestionAnalysis" class="space-y-4">
                                        <!-- Question analysis will be populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Close Button -->
                            <div class="mt-8 text-center">
                                <button onclick="closeTeacherAssignmentDetails()" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">
                                    Close Details
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="bg-gray-100 dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 py-8 mt-12">
                    <div class="max-w-6xl mx-auto px-4">
                        <div class="flex flex-col md:flex-row items-center justify-between">
                            <div class="flex items-center space-x-4 mb-4 md:mb-0">
                                <img src="https://pfst.cf2.poecdn.net/base/image/be94ad793df5c5fef6abb3606c29b6e8f15daaa53635ceb2e12adf1f3817c520?w=1080&h=1080" alt="Cortexo Logo" class="w-12 h-12 rounded-lg">
                                <div>
                                    <div class="text-lg font-bold text-gray-800 dark:text-gray-200">Cortexo</div>
                                    <div class="text-sm text-gray-600 dark:text-gray-400">Where Education Meets Adventure</div>
                                </div>
                            </div>
                            
                            <div class="text-center md:text-right">
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    ¬© 2025 Cortexo. All rights reserved.
                                </div>
                                <div class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                    Transforming learning into epic adventures
                                </div>
                            </div>
                        </div>
                    </div>
                </footer>
            `;
            
            document.body.appendChild(teacherDashboard);
            
            // Update Rhino controls to reflect current state
            setTimeout(() => {
                updateTeacherRhinoUI();
            }, 100);
            
            // Set default due date to next Friday
            const nextFriday = new Date();
            nextFriday.setDate(nextFriday.getDate() + (5 - nextFriday.getDay() + 7) % 7);
            if (nextFriday <= new Date()) {
                nextFriday.setDate(nextFriday.getDate() + 7);
            }
            document.getElementById('assignmentDueDate').value = nextFriday.toISOString().split('T')[0];
        }

        // Question Generation Wizard state
        let currentAssignmentData = {};
        let generatedQuestions = [];

        // Open Question Generation Wizard (replaces old createAssignment)
        function createAssignment() {
            const titleEl = document.getElementById('assignmentTitle');
            const subjectEl = document.getElementById('assignmentSubject');
            const descriptionEl = document.getElementById('assignmentDescription');
            const dueDateEl = document.getElementById('assignmentDueDate');
            const questionCountEl = document.getElementById('assignmentQuestionCount');

            // Check if all required elements exist
            if (!titleEl || !subjectEl || !descriptionEl || !dueDateEl || !questionCountEl) {
                showCustomAlert('Assignment form elements not found. Please try again.');
                return;
            }

            const title = titleEl.value.trim();
            const subject = subjectEl.value;
            const description = descriptionEl.value.trim();
            const dueDate = dueDateEl.value;
            const questionCount = questionCountEl.value;

            if (!title || !description || !dueDate) {
                showCustomAlert('Please fill in all required fields!');
                return;
            }

            // Store assignment data for wizard
            currentAssignmentData = {
                title: title,
                subject: subject,
                description: description,
                dueDate: dueDate,
                questionCount: parseInt(questionCount),
                createdAt: new Date().toISOString()
            };

            // Show wizard modal first
            const wizardModal = document.getElementById('questionWizardModal');
            if (!wizardModal) {
                showCustomAlert('Question wizard not available. Please try again.');
                return;
            }

            wizardModal.classList.remove('hidden');

            // Wait a moment for modal to render, then populate
            setTimeout(() => {
                // Populate wizard summary (with error checking)
                const wizardTitleEl = document.getElementById('wizardAssignmentTitle');
                const wizardSubjectEl = document.getElementById('wizardAssignmentSubject');
                const wizardQuestionCountEl = document.getElementById('wizardQuestionCount');
                const wizardDueDateEl = document.getElementById('wizardDueDate');

                if (wizardTitleEl) wizardTitleEl.textContent = title;
                if (wizardSubjectEl) wizardSubjectEl.textContent = subject.charAt(0).toUpperCase() + subject.slice(1);
                if (wizardQuestionCountEl) wizardQuestionCountEl.textContent = questionCount;
                
                if (wizardDueDateEl) {
                    const dueDateFormatted = new Date(dueDate).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    wizardDueDateEl.textContent = dueDateFormatted;
                }

                // Reset wizard to step 1
                const wizardStep1 = document.getElementById('wizardStep1');
                const wizardStep2 = document.getElementById('wizardStep2');
                const wizardLoading = document.getElementById('wizardLoading');

                if (wizardStep1) wizardStep1.classList.remove('hidden');
                if (wizardStep2) wizardStep2.classList.add('hidden');
                if (wizardLoading) wizardLoading.classList.add('hidden');

                // Pre-fill topic based on description
                const questionTopicEl = document.getElementById('questionTopic');
                if (questionTopicEl) {
                    questionTopicEl.value = description;
                }
            }, 100);
        }

        // Close Question Wizard
        function closeQuestionWizard() {
            document.getElementById('questionWizardModal').classList.add('hidden');
        }

        // Generate questions using AI
        async function generateQuestions() {
            // Determine which tab is active by checking which content section is visible
            let activeTab = 'create'; // default
            
            if (!document.getElementById('pasteContentSection').classList.contains('hidden')) {
                activeTab = 'paste';
            } else if (!document.getElementById('uploadContentSection').classList.contains('hidden')) {
                activeTab = 'upload';
            } else if (!document.getElementById('createContentSection').classList.contains('hidden')) {
                activeTab = 'create';
            }
            
            let prompt = '';
            
            if (activeTab === 'paste') {
                // Handle paste questions mode
                const pastedQuestions = document.getElementById('pastedQuestions').value.trim();
                const pasteInstructions = document.getElementById('pasteInstructions').value.trim();
                
                if (!pastedQuestions) {
                    showCustomAlert('Please paste your questions first!');
                    return;
                }
                
                prompt = `@Claude-Sonnet-4 Convert these pasted questions into a standardized multiple-choice format. ${pasteInstructions ? 'Additional instructions: ' + pasteInstructions : ''}

Original Questions:
${pastedQuestions}

Convert to ${currentAssignmentData.questionCount} multiple choice questions. If there are more than ${currentAssignmentData.questionCount} questions, select the best ones. If there are fewer, create additional similar questions.

Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`). Format: {"questions": [{"question": "Question text", "options": ["A", "B", "C", "D"], "correct": 0, "explanation": "Why this is correct"}]}`;

            } else if (activeTab === 'upload') {
                // Handle PDF upload mode
                const pdfInstructions = document.getElementById('pdfInstructions').value.trim();
                
                if (!window.uploadedPDF) {
                    showCustomAlert('Please upload a PDF file first!');
                    return;
                }
                
                prompt = `@Claude-Sonnet-4 Generate ${currentAssignmentData.questionCount} multiple choice questions based on the content in the uploaded PDF. ${pdfInstructions ? 'Focus on: ' + pdfInstructions : ''}

Create questions that test understanding of the key concepts from the document.

Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`). Format: {"questions": [{"question": "Question text", "options": ["A", "B", "C", "D"], "correct": 0, "explanation": "Why this is correct"}]}`;

            } else {
                // Handle create new mode (default)
                const topic = document.getElementById('questionTopic').value.trim();
                const difficulty = document.getElementById('difficultyLevel').value;
                const questionStyle = document.getElementById('questionStyle').value;
                
                if (!topic) {
                    showCustomAlert('Please enter a topic to create questions about!');
                    return;
                }
                
                prompt = `@Claude-Sonnet-4 Generate ${currentAssignmentData.questionCount} ${questionStyle} questions about "${topic}" at ${difficulty} level for ${currentAssignmentData.subject}.

Create engaging, educational questions that test understanding of key concepts.

Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`). Format: {"questions": [{"question": "Question text", "options": ["A", "B", "C", "D"], "correct": 0, "explanation": "Why this is correct"}]}`;
            }

            // Show loading state
            document.getElementById('wizardStep1').classList.add('hidden');
            document.getElementById('wizardLoading').classList.remove('hidden');

            try {
                // Register handler for question generation
                window.Poe.registerHandler("question-generator", (result) => {
                    const response = result.responses[0];
                    if (response.status === "complete") {
                        try {
                            const questionsData = JSON.parse(response.content);
                            generatedQuestions = questionsData.questions || questionsData;
                            displayGeneratedQuestions();
                        } catch (e) {
                            showQuestionError("Failed to parse questions. Please try again.");
                        }
                    } else if (response.status === "error") {
                        showQuestionError("Failed to generate questions. Please try again.");
                    }
                });

                // Send message with or without PDF attachment
                const messageOptions = {
                    handler: "question-generator",
                    stream: false,
                    openChat: false
                };

                // Add PDF as attachment if in upload mode
                if (activeTab === 'upload' && window.uploadedPDF) {
                    messageOptions.attachments = [window.uploadedPDF];
                }

                await window.Poe.sendUserMessage(prompt, messageOptions);
            } catch (error) {
                showQuestionError("Failed to generate questions. Please try again.");
            }
        }

        // Display generated questions for review
        function displayGeneratedQuestions() {
            const questionsList = document.getElementById('questionsList');
            let html = '';

            generatedQuestions.forEach((q, index) => {
                html += `
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 border">
                        <div class="flex justify-between items-start mb-3">
                            <h5 class="font-medium text-lg">Question ${index + 1}</h5>
                            <button onclick="editQuestion(${index})" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                        </div>
                        
                        <div class="mb-3">
                            <div class="font-medium text-gray-800 dark:text-gray-200 mb-2">${q.question}</div>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${q.options.map((option, oIndex) => `
                                    <div class="flex items-center space-x-2 ${oIndex === q.correct ? 'text-green-600 font-semibold' : 'text-gray-600 dark:text-gray-400'}">
                                        <span class="w-5 h-5 rounded-full border ${oIndex === q.correct ? 'bg-green-100 border-green-500' : 'border-gray-300'} flex items-center justify-center text-xs">
                                            ${String.fromCharCode(65 + oIndex)}
                                        </span>
                                        <span>${option}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        ${q.explanation ? `
                            <div class="text-xs text-gray-500 bg-gray-100 dark:bg-gray-600 p-2 rounded">
                                <strong>Explanation:</strong> ${q.explanation}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            questionsList.innerHTML = html;

            // Show step 2
            document.getElementById('wizardLoading').classList.add('hidden');
            document.getElementById('wizardStep2').classList.remove('hidden');
        }

        // Show question generation error
        function showQuestionError(message) {
            document.getElementById('wizardLoading').innerHTML = `
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h4 class="text-xl font-bold mb-2 text-red-600">Error</h4>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">${message}</p>
                    <button onclick="goBackToStep1()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                        Try Again
                    </button>
                </div>
            `;
        }

        // Edit a specific question (simplified for demo)
        function editQuestion(index) {
            const question = generatedQuestions[index];
            const newText = prompt(`Edit question ${index + 1}:`, question.question);
            if (newText && newText.trim()) {
                generatedQuestions[index].question = newText.trim();
                displayGeneratedQuestions();
            }
        }

        // Go back to step 1
        function goBackToStep1() {
            document.getElementById('wizardStep2').classList.add('hidden');
            document.getElementById('wizardLoading').classList.add('hidden');
            document.getElementById('wizardStep1').classList.remove('hidden');
        }

        // Regenerate all questions
        function regenerateQuestions() {
            generateQuestions();
        }

        // Preview assignment (show how students will see it)
        function previewAssignment() {
            showCustomAlert('Preview would show students exactly how they\'ll experience this assignment in battle mode!');
        }

        // Handle PDF Upload
        function handlePDFUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (file.type !== 'application/pdf') {
                showCustomAlert('Please upload a PDF file only.');
                return;
            }

            // Validate file size (10MB limit)
            const maxSize = 10 * 1024 * 1024; // 10MB in bytes
            if (file.size > maxSize) {
                showCustomAlert('File size must be under 10MB. Please choose a smaller file.');
                return;
            }

            // Show upload success
            document.getElementById('uploadedFileName').textContent = file.name;
            document.getElementById('uploadStatus').classList.remove('hidden');
            
            // Store the file for later use
            window.uploadedPDF = file;
            
            showCustomAlert(`üìÑ ${file.name} uploaded successfully! AI will analyze this content when generating questions.`);
        }

        // Switch between content input tabs
        function switchContentTab(tab) {
            const createTab = document.getElementById('createContentTab');
            const pasteTab = document.getElementById('pasteContentTab');
            const uploadTab = document.getElementById('uploadContentTab');
            const createSection = document.getElementById('createContentSection');
            const pasteSection = document.getElementById('pasteContentSection');
            const uploadSection = document.getElementById('uploadContentSection');

            // Reset all tabs and sections
            createTab.className = 'px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
            pasteTab.className = 'px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
            uploadTab.className = 'px-4 py-3 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:hover:text-gray-300';
            
            createSection.classList.add('hidden');
            pasteSection.classList.add('hidden');
            uploadSection.classList.add('hidden');

            if (tab === 'create') {
                createTab.className = 'px-4 py-3 font-medium border-b-2 border-purple-600 text-purple-600';
                createSection.classList.remove('hidden');
            } else if (tab === 'paste') {
                pasteTab.className = 'px-4 py-3 font-medium border-b-2 border-purple-600 text-purple-600';
                pasteSection.classList.remove('hidden');
            } else if (tab === 'upload') {
                uploadTab.className = 'px-4 py-3 font-medium border-b-2 border-purple-600 text-purple-600';
                uploadSection.classList.remove('hidden');
            }
        }

        // Enhanced generate questions function to handle PDF uploads
        async function generateQuestionsFromContent() {
            const activeTab = document.getElementById('uploadContentTab').classList.contains('text-purple-600') ? 'upload' : 'manual';
            
            let objectives = '';
            let keyTopics = '';
            let additionalInstructions = '';
            
            if (activeTab === 'manual') {
                objectives = document.getElementById('learningObjectives').value.trim();
                keyTopics = document.getElementById('keyTopics').value.trim();
                
                if (!objectives) {
                    showCustomAlert('Please define learning objectives!');
                    return;
                }
            } else {
                // PDF upload mode
                if (!window.uploadedPDF) {
                    showCustomAlert('Please upload a PDF file first!');
                    return;
                }
                
                additionalInstructions = document.getElementById('pdfInstructions').value.trim();
                objectives = `Generate questions based on the uploaded PDF content. ${additionalInstructions ? 'Additional focus: ' + additionalInstructions : ''}`;
            }

            const difficulty = document.getElementById('difficultyLevel').value;
            const questionStyle = document.getElementById('questionStyle').value;

            // Show loading state
            document.getElementById('wizardStep1').classList.add('hidden');
            document.getElementById('wizardLoading').classList.remove('hidden');

            try {
                // Register handler for question generation
                window.Poe.registerHandler("question-generator", (result) => {
                    const response = result.responses[0];
                    if (response.status === "complete") {
                        try {
                            const questionsData = JSON.parse(response.content);
                            generatedQuestions = questionsData.questions || questionsData;
                            displayGeneratedQuestions();
                        } catch (e) {
                            showQuestionError("Failed to parse questions. Please try again.");
                        }
                    } else if (response.status === "error") {
                        showQuestionError("Failed to generate questions. Please try again.");
                    }
                });

                // Create AI prompt
                let prompt = `@Claude-Sonnet-4 Generate ${currentAssignmentData.questionCount} ${questionStyle} questions for ${currentAssignmentData.subject} at ${difficulty} level.

${activeTab === 'manual' ? `Learning Objectives: ${objectives}` : `Instructions: ${objectives}`}
${keyTopics ? `Key Topics: ${keyTopics}` : ''}

Provide ONLY raw JSON in your response with no explanations, additional text, or code block formatting (no \`\`\`). Format: {"questions": [{"question": "Question text", "options": ["A", "B", "C", "D"], "correct": 0, "explanation": "Why this is correct"}]}`;

                // Send message with or without PDF attachment
                const messageOptions = {
                    handler: "question-generator",
                    stream: false,
                    openChat: false
                };

                // Add PDF as attachment if available
                if (activeTab === 'upload' && window.uploadedPDF) {
                    messageOptions.attachments = [window.uploadedPDF];
                }

                await window.Poe.sendUserMessage(prompt, messageOptions);
            } catch (error) {
                showQuestionError("Failed to generate questions. Please try again.");
            }
        }

        // Deploy assignment to students
        function deployAssignment() {
            // Add to active assignments list with the generated questions
            const activeList = document.getElementById('activeAssignments');
            const subjectColors = {
                algebra: 'yellow',
                chemistry: 'blue', 
                history: 'green',
                english: 'purple',
                physics: 'red',
                biology: 'teal'
            };
            
            const color = subjectColors[currentAssignmentData.subject] || 'gray';
            const dueDateFormatted = new Date(currentAssignmentData.dueDate).toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric' 
            });

            const assignmentHTML = `
                <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h4 class="font-semibold text-${color}-700 dark:text-${color}-400">${currentAssignmentData.title}</h4>
                        <span class="text-xs bg-${color}-100 dark:bg-${color}-900/50 text-${color}-700 dark:text-${color}-300 px-2 py-1 rounded">${currentAssignmentData.subject.charAt(0).toUpperCase() + currentAssignmentData.subject.slice(1)}</span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">${currentAssignmentData.description}</p>
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>Due: ${dueDateFormatted}</span>
                        <span>0/28 completed ‚Ä¢ ${generatedQuestions.length} AI questions</span>
                    </div>
                </div>
            `;

            activeList.insertAdjacentHTML('afterbegin', assignmentHTML);

            // Clear form
            document.getElementById('assignmentForm').reset();
            
            // Reset due date to next Friday
            const nextFriday = new Date();
            nextFriday.setDate(nextFriday.getDate() + (5 - nextFriday.getDay() + 7) % 7);
            if (nextFriday <= new Date()) {
                nextFriday.setDate(nextFriday.getDate() + 7);
            }
            document.getElementById('assignmentDueDate').value = nextFriday.toISOString().split('T')[0];

            // Close wizard
            closeQuestionWizard();

            // Success message
            showCustomAlert(`üöÄ "${currentAssignmentData.title}" deployed with ${generatedQuestions.length} AI-generated questions! Students can now battle these questions.`);
        }

        // Exit teacher mode
        function exitTeacherMode() {
            // Remove teacher dashboard
            const dashboard = document.getElementById('teacherDashboard');
            if (dashboard) {
                dashboard.remove();
            }
            
            // FULLY RESTORE the student interface
            const elementsToRestore = [
                'header',
                '.max-w-6xl',
                'footer',
                '.battle-arena',
                '.grid.md\\:grid-cols-3.gap-8'
            ];
            
            elementsToRestore.forEach(selector => {
                const elements = document.querySelectorAll(selector);
                elements.forEach(el => {
                    if (el) {
                        el.style.display = '';
                        el.style.visibility = '';
                        el.style.opacity = '';
                        el.style.height = '';
                        el.style.overflow = '';
                    }
                });
            });
            
            showCustomAlert('üë®‚Äçüéì Switched back to student view. Students can now battle the assignments you created!');
        }

        // Password strength checking functions
        function checkPasswordStrength(userType) {
            const password = document.getElementById(`${userType}Password`).value;
            const req1 = document.getElementById(`${userType}Req1`);
            const req2 = document.getElementById(`${userType}Req2`);
            const req3 = document.getElementById(`${userType}Req3`);
            const req4 = document.getElementById(`${userType}Req4`);

            // Check length (8+ characters)
            if (password.length >= 8) {
                req1.innerHTML = '<span class="mr-1 text-green-500">‚úì</span> 8+ characters';
                req1.className = 'flex items-center text-green-600 dark:text-green-400';
            } else {
                req1.innerHTML = '<span class="mr-1">‚óã</span> 8+ characters';
                req1.className = 'flex items-center text-gray-500';
            }

            // Check uppercase
            if (/[A-Z]/.test(password)) {
                req2.innerHTML = '<span class="mr-1 text-green-500">‚úì</span> Uppercase letter';
                req2.className = 'flex items-center text-green-600 dark:text-green-400';
            } else {
                req2.innerHTML = '<span class="mr-1">‚óã</span> Uppercase letter';
                req2.className = 'flex items-center text-gray-500';
            }

            // Check lowercase
            if (/[a-z]/.test(password)) {
                req3.innerHTML = '<span class="mr-1 text-green-500">‚úì</span> Lowercase letter';
                req3.className = 'flex items-center text-green-600 dark:text-green-400';
            } else {
                req3.innerHTML = '<span class="mr-1">‚óã</span> Lowercase letter';
                req3.className = 'flex items-center text-gray-500';
            }

            // Check number
            if (/\d/.test(password)) {
                req4.innerHTML = '<span class="mr-1 text-green-500">‚úì</span> Number';
                req4.className = 'flex items-center text-green-600 dark:text-green-400';
            } else {
                req4.innerHTML = '<span class="mr-1">‚óã</span> Number';
                req4.className = 'flex items-center text-gray-500';
            }

            // Also check password match if confirm field has content
            const confirmPassword = document.getElementById(`${userType}ConfirmPassword`).value;
            if (confirmPassword) {
                checkPasswordMatch(userType);
            }
        }

        function checkPasswordMatch(userType) {
            const password = document.getElementById(`${userType}Password`).value;
            const confirmPassword = document.getElementById(`${userType}ConfirmPassword`).value;
            const matchDiv = document.getElementById(`${userType}PasswordMatch`);

            if (confirmPassword === '') {
                matchDiv.classList.add('hidden');
                return;
            }

            matchDiv.classList.remove('hidden');

            if (password === confirmPassword) {
                matchDiv.innerHTML = '<span class="text-green-600 dark:text-green-400">‚úì Passwords match</span>';
            } else {
                matchDiv.innerHTML = '<span class="text-red-600 dark:text-red-400">‚úó Passwords do not match</span>';
            }
        }

        // Updated sign up functions to check password confirmation and show subscription modal
        function signUpStudentUpdated() {
            const username = document.getElementById('studentUsername').value.trim();
            const email = document.getElementById('studentEmail').value.trim();
            const password = document.getElementById('studentPassword').value.trim();
            const confirmPassword = document.getElementById('studentConfirmPassword').value.trim();
            const grade = document.getElementById('studentGrade').value;

            if (!username || !email || !password || !confirmPassword || !grade) {
                showCustomAlert('Please fill in all fields to start your learning battle!');
                return;
            }

            if (password !== confirmPassword) {
                showCustomAlert('Passwords do not match! Please check your password confirmation.');
                return;
            }

            if (password.length < 8) {
                showCustomAlert('Password must be at least 8 characters long!');
                return;
            }
            
            // Check for secure password requirements
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            
            if (!hasUppercase || !hasLowercase || !hasNumbers) {
                showCustomAlert('Password must contain at least one uppercase letter, one lowercase letter, and one number!');
                return;
            }

            // Set user as student
            appState.isSignedUp = true;
            appState.isDemoMode = false;
            appState.userRole = 'student';
            appState.username = username;
            appState.email = email;
            appState.userDetails = { grade: grade };

            // Hide welcome screen
            document.getElementById('welcomeScreen').classList.add('hidden');
            
            // Show subscription modal first
            openSubscriptionModal();
            
            // After subscription selection, show the main interface
            setTimeout(() => {
                document.getElementById('userWelcome').classList.remove('hidden');
                document.getElementById('displayUsername').textContent = username;
            }, 500);
        }

        function signUpTeacherUpdated() {
            const username = document.getElementById('teacherUsername').value.trim();
            const email = document.getElementById('teacherEmail').value.trim();
            const password = document.getElementById('teacherPassword').value.trim();
            const confirmPassword = document.getElementById('teacherConfirmPassword').value.trim();
            const subject = document.getElementById('teacherSubject').value;
            const school = document.getElementById('schoolName').value.trim();

            if (!username || !email || !password || !confirmPassword || !subject || !school) {
                showCustomAlert('Please fill in all fields to create your teacher account!');
                return;
            }

            if (password !== confirmPassword) {
                showCustomAlert('Passwords do not match! Please check your password confirmation.');
                return;
            }

            if (password.length < 8) {
                showCustomAlert('Password must be at least 8 characters long!');
                return;
            }
            
            // Check for secure password requirements
            const hasUppercase = /[A-Z]/.test(password);
            const hasLowercase = /[a-z]/.test(password);
            const hasNumbers = /\d/.test(password);
            
            if (!hasUppercase || !hasLowercase || !hasNumbers) {
                showCustomAlert('Password must contain at least one uppercase letter, one lowercase letter, and one number!');
                return;
            }

            // Set user as teacher
            appState.isSignedUp = true;
            appState.isDemoMode = false;
            appState.userRole = 'teacher';
            appState.username = username;
            appState.email = email;
            appState.userDetails = { subject: subject, school: school };

            // Hide welcome screen
            document.getElementById('welcomeScreen').classList.add('hidden');
            
            // Show subscription modal first
            openSubscriptionModal();
            
            // After subscription, show teacher dashboard or main interface
            setTimeout(() => {
                showTeacherDashboard();
            }, 1000);
        }

        // Assignment details data
        const assignmentDetailsData = {
            'algebra-prep': {
                title: 'Algebra Test Prep',
                subject: 'Mathematics ‚Ä¢ Due Friday',
                stats: {
                    completionRate: '64%',
                    avgScore: '78%',
                    battlesWon: '14',
                    avgTime: '4.2m'
                },
                students: [
                    {
                        name: 'Alex Johnson',
                        avatar: 'üß†',
                        rank: 'Brain Champion',
                        status: 'Completed',
                        score: '9/10 (90%)',
                        time: '3.2m',
                        xpGained: '+180 XP',
                        attempts: '1',
                        battleResult: 'üèÜ Victory'
                    },
                    {
                        name: 'Emma Davis',
                        avatar: 'üòé',
                        rank: 'Academic Fighter',
                        status: 'Completed',
                        score: '8/10 (80%)',
                        time: '4.1m',
                        xpGained: '+160 XP',
                        attempts: '1',
                        battleResult: '‚öîÔ∏è Win'
                    },
                    {
                        name: 'Sarah Wilson',
                        avatar: 'ü¶Ñ',
                        rank: 'Study Warrior',
                        status: 'Completed',
                        score: '7/10 (70%)',
                        time: '5.3m',
                        xpGained: '+140 XP',
                        attempts: '2',
                        battleResult: 'üí™ Solid'
                    },
                    {
                        name: 'Michael Chen',
                        avatar: 'ü§ì',
                        rank: 'Knowledge Seeker',
                        status: 'In Progress',
                        score: '4/6 (67%)',
                        time: '2.8m',
                        xpGained: '+80 XP',
                        attempts: '1',
                        battleResult: '‚ö° Fighting'
                    },
                    {
                        name: 'David Lopez',
                        avatar: 'ü¶Ö',
                        rank: 'Eager Learner',
                        status: 'Pending',
                        score: '-',
                        time: '-',
                        xpGained: '-',
                        attempts: '0',
                        battleResult: 'üò¥ Not Started'
                    }
                ],
                questions: [
                    {
                        question: 'What is the solution to 2x + 5 = 13?',
                        correctRate: '85%',
                        commonMistakes: ['Forgot to subtract 5', 'Division error'],
                        difficulty: 'Easy'
                    },
                    {
                        question: 'Which is the vertex form of a quadratic equation?',
                        correctRate: '72%',
                        commonMistakes: ['Confused with standard form', 'Mixed up variables'],
                        difficulty: 'Medium'
                    },
                    {
                        question: 'If f(x) = x¬≤ - 4x + 3, what is f(2)?',
                        correctRate: '68%',
                        commonMistakes: ['Calculation errors', 'Forgot to substitute'],
                        difficulty: 'Medium'
                    },
                    {
                        question: 'What are the roots of x¬≤ - 5x + 6 = 0?',
                        correctRate: '45%',
                        commonMistakes: ['Factoring errors', 'Sign mistakes'],
                        difficulty: 'Hard'
                    }
                ]
            },
            'chemistry-review': {
                title: 'Chemistry Test Review',
                subject: 'Science ‚Ä¢ Due Monday',
                stats: {
                    completionRate: '43%',
                    avgScore: '71%',
                    battlesWon: '8',
                    avgTime: '5.1m'
                },
                students: [
                    {
                        name: 'Emma Davis',
                        avatar: 'üòé',
                        rank: 'Academic Fighter',
                        status: 'Completed',
                        score: '7/8 (88%)',
                        time: '4.5m',
                        xpGained: '+175 XP',
                        attempts: '1',
                        battleResult: 'üèÜ Victory'
                    },
                    {
                        name: 'Lisa Park',
                        avatar: 'üî•',
                        rank: 'Study Master',
                        status: 'Completed',
                        score: '6/8 (75%)',
                        time: '6.2m',
                        xpGained: '+150 XP',
                        attempts: '1',
                        battleResult: '‚öîÔ∏è Win'
                    },
                    {
                        name: 'James Taylor',
                        avatar: '‚ö°',
                        rank: 'Knowledge Seeker',
                        status: 'In Progress',
                        score: '3/5 (60%)',
                        time: '3.1m',
                        xpGained: '+90 XP',
                        attempts: '1',
                        battleResult: '‚ö° Fighting'
                    }
                ],
                questions: [
                    {
                        question: 'What is the atomic number of Carbon?',
                        correctRate: '92%',
                        commonMistakes: ['Confused with atomic mass'],
                        difficulty: 'Easy'
                    },
                    {
                        question: 'Which type of bond forms between Na and Cl?',
                        correctRate: '78%',
                        commonMistakes: ['Thought it was covalent'],
                        difficulty: 'Medium'
                    },
                    {
                        question: 'What is the pH of a neutral solution?',
                        correctRate: '65%',
                        commonMistakes: ['Confused with basic/acidic'],
                        difficulty: 'Medium'
                    },
                    {
                        question: 'How many electrons can the second shell hold?',
                        correctRate: '52%',
                        commonMistakes: ['Mixed up with first shell', 'Calculation errors'],
                        difficulty: 'Hard'
                    }
                ]
            },
            'history-exam': {
                title: 'History Exam Prep',
                subject: 'History ‚Ä¢ Due in 2 weeks',
                stats: {
                    completionRate: '29%',
                    avgScore: '82%',
                    battlesWon: '6',
                    avgTime: '6.8m'
                },
                students: [
                    {
                        name: 'Alex Johnson',
                        avatar: 'üß†',
                        rank: 'Brain Champion',
                        status: 'Completed',
                        score: '11/12 (92%)',
                        time: '5.9m',
                        xpGained: '+220 XP',
                        attempts: '1',
                        battleResult: 'üèÜ Victory'
                    },
                    {
                        name: 'Rachel Green',
                        avatar: 'üåü',
                        rank: 'Learning Legend',
                        status: 'Completed',
                        score: '10/12 (83%)',
                        time: '7.2m',
                        xpGained: '+200 XP',
                        attempts: '1',
                        battleResult: 'üèÜ Victory'
                    }
                ],
                questions: [
                    {
                        question: 'In which year did World War II begin?',
                        correctRate: '88%',
                        commonMistakes: ['Confused with WWI dates'],
                        difficulty: 'Easy'
                    },
                    {
                        question: 'Who was the leader of Nazi Germany?',
                        correctRate: '95%',
                        commonMistakes: ['Very few mistakes'],
                        difficulty: 'Easy'
                    },
                    {
                        question: 'Which event brought the US into WWII?',
                        correctRate: '76%',
                        commonMistakes: ['Confused with other events'],
                        difficulty: 'Medium'
                    },
                    {
                        question: 'When did WWII end in Europe?',
                        correctRate: '58%',
                        commonMistakes: ['Mixed up with Pacific end date', 'Month confusion'],
                        difficulty: 'Hard'
                    }
                ]
            }
        };

        // Show assignment details
        function showAssignmentDetails(assignmentId) {
            const data = assignmentDetailsData[assignmentId];
            if (!data) return;

            // Populate assignment header
            document.getElementById('detailsAssignmentTitle').textContent = data.title;
            document.getElementById('detailsAssignmentSubject').textContent = data.subject;

            // Populate stats
            document.getElementById('detailsCompletionRate').textContent = data.stats.completionRate;
            document.getElementById('detailsAvgScore').textContent = data.stats.avgScore;
            document.getElementById('detailsBattlesWon').textContent = data.stats.battlesWon;
            document.getElementById('detailsAvgTime').textContent = data.stats.avgTime;

            // Populate student results table
            const tableBody = document.getElementById('studentResultsTable');
            tableBody.innerHTML = data.students.map(student => `
                <tr class="border-b border-gray-100 dark:border-gray-700">
                    <td class="py-3 px-6">
                        <div class="flex items-center">
                            <span class="text-lg mr-3">${student.avatar}</span>
                            <div>
                                <div class="font-medium">${student.name}</div>
                                <div class="text-xs text-gray-500">${student.rank}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-6">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            student.status === 'Completed' ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' :
                            student.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300' :
                            'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                        }">
                            ${student.status}
                        </span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="font-semibold ${student.score === '-' ? 'text-gray-400' : 'text-gray-800 dark:text-gray-200'}">${student.score}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="${student.time === '-' ? 'text-gray-400' : 'text-gray-600 dark:text-gray-400'}">${student.time}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="font-semibold ${student.xpGained === '-' ? 'text-gray-400' : 'text-blue-600'}">${student.xpGained}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="text-gray-600 dark:text-gray-400">${student.attempts}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="text-sm">${student.battleResult}</span>
                    </td>
                </tr>
            `).join('');

            // Populate question analysis
            const questionAnalysis = document.getElementById('questionAnalysis');
            questionAnalysis.innerHTML = data.questions.map((q, index) => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-medium">Question ${index + 1}: ${q.question}</h5>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded text-xs font-medium ${
                                q.difficulty === 'Easy' ? 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300' :
                                q.difficulty === 'Medium' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300' :
                                'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300'
                            }">${q.difficulty}</span>
                            <span class="text-lg font-bold ${
                                parseInt(q.correctRate) >= 75 ? 'text-green-600' :
                                parseInt(q.correctRate) >= 50 ? 'text-yellow-600' : 'text-red-600'
                            }">${q.correctRate}</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="h-2 rounded-full ${
                                parseInt(q.correctRate) >= 75 ? 'bg-green-500' :
                                parseInt(q.correctRate) >= 50 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${q.correctRate}"></div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <strong>Common Mistakes:</strong> ${q.commonMistakes.join(', ')}
                    </div>
                </div>
            `).join('');

            // Show modal
            document.getElementById('assignmentDetailsModal').classList.remove('hidden');
        }

        // Close assignment details
        function closeAssignmentDetails() {
            document.getElementById('assignmentDetailsModal').classList.add('hidden');
        }

        // Show teacher assignment details (uses separate modal inside teacher dashboard)
        function showTeacherAssignmentDetails(assignmentId) {
            const data = assignmentDetailsData[assignmentId];
            if (!data) return;

            // Populate assignment header in teacher modal
            document.getElementById('teacherDetailsAssignmentTitle').textContent = data.title;
            document.getElementById('teacherDetailsAssignmentSubject').textContent = data.subject;

            // Populate stats in teacher modal
            document.getElementById('teacherDetailsCompletionRate').textContent = data.stats.completionRate;
            document.getElementById('teacherDetailsAvgScore').textContent = data.stats.avgScore;
            document.getElementById('teacherDetailsBattlesWon').textContent = data.stats.battlesWon;
            document.getElementById('teacherDetailsAvgTime').textContent = data.stats.avgTime;

            // Populate student results table in teacher modal
            const tableBody = document.getElementById('teacherStudentResultsTable');
            tableBody.innerHTML = data.students.map(student => `
                <tr class="border-b border-gray-100 dark:border-gray-700">
                    <td class="py-3 px-6">
                        <div class="flex items-center">
                            <span class="text-lg mr-3">${student.avatar}</span>
                            <div>
                                <div class="font-medium">${student.name}</div>
                                <div class="text-xs text-gray-500">${student.rank}</div>
                            </div>
                        </div>
                    </td>
                    <td class="py-3 px-6">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${
                            student.status === 'Completed' ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300' :
                            student.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300' :
                            'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'
                        }">
                            ${student.status}
                        </span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="font-semibold ${student.score === '-' ? 'text-gray-400' : 'text-gray-800 dark:text-gray-200'}">${student.score}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="${student.time === '-' ? 'text-gray-400' : 'text-gray-600 dark:text-gray-400'}">${student.time}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="font-semibold ${student.xpGained === '-' ? 'text-gray-400' : 'text-blue-600'}">${student.xpGained}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="text-gray-600 dark:text-gray-400">${student.attempts}</span>
                    </td>
                    <td class="py-3 px-6">
                        <span class="text-sm">${student.battleResult}</span>
                    </td>
                </tr>
            `).join('');

            // Populate question analysis in teacher modal
            const questionAnalysis = document.getElementById('teacherQuestionAnalysis');
            questionAnalysis.innerHTML = data.questions.map((q, index) => `
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-medium">Question ${index + 1}: ${q.question}</h5>
                        <div class="flex items-center space-x-2">
                            <span class="px-2 py-1 rounded text-xs font-medium ${
                                q.difficulty === 'Easy' ? 'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300' :
                                q.difficulty === 'Medium' ? 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-300' :
                                'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300'
                            }">${q.difficulty}</span>
                            <span class="text-lg font-bold ${
                                parseInt(q.correctRate) >= 75 ? 'text-green-600' :
                                parseInt(q.correctRate) >= 50 ? 'text-yellow-600' : 'text-red-600'
                            }">${q.correctRate}</span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                            <div class="h-2 rounded-full ${
                                parseInt(q.correctRate) >= 75 ? 'bg-green-500' :
                                parseInt(q.correctRate) >= 50 ? 'bg-yellow-500' : 'bg-red-500'
                            }" style="width: ${q.correctRate}"></div>
                        </div>
                    </div>
                    
                    <div class="text-sm text-gray-600 dark:text-gray-400">
                        <strong>Common Mistakes:</strong> ${q.commonMistakes.join(', ')}
                    </div>
                </div>
            `).join('');

            // Show teacher modal
            document.getElementById('teacherAssignmentDetailsModal').classList.remove('hidden');
        }

        // Close teacher assignment details
        function closeTeacherAssignmentDetails() {
            document.getElementById('teacherAssignmentDetailsModal').classList.add('hidden');
        }

        // Subscription modal functions
        function openSubscriptionModal() {
            document.getElementById('subscriptionModal').classList.remove('hidden');
        }

        function closeSubscriptionModal() {
            document.getElementById('subscriptionModal').classList.add('hidden');
        }

        function selectPlan(planType) {
            if (planType === 'free') {
                // Continue with free plan
                closeSubscriptionModal();
                showCustomAlert('üéÆ Welcome to Rival You! You can upgrade anytime to unlock more features.');
            } else if (planType === 'premium') {
                // Show premium subscription flow
                handlePremiumSubscription();
            } else if (planType === 'teacher') {
                // Show teacher subscription flow
                handleTeacherSubscription();
            }
        }

        function handlePremiumSubscription() {
            // In a real app, this would integrate with Stripe/PayPal/etc.
            showCustomAlert('üöÄ Premium subscription would normally redirect to payment processor (Stripe, PayPal, etc.)');
            closeSubscriptionModal();
            
            // For demo, simulate successful subscription
            setTimeout(() => {
                showCustomAlert('üéâ Welcome to Premium! You now have unlimited battles and AI insights!');
                appState.subscriptionTier = 'premium';
            }, 2000);
        }

        function handleTeacherSubscription() {
            // In a real app, this would integrate with payment processor
            showCustomAlert('üë©‚Äçüè´ Teacher subscription would normally redirect to payment processor with school billing options.');
            closeSubscriptionModal();
            
            // For demo, simulate successful subscription
            setTimeout(() => {
                showCustomAlert('üéì Welcome to Classroom Hero! You can now create unlimited AI-powered assignments!');
                appState.subscriptionTier = 'teacher';
            }, 2000);
        }

        // Add subscription tier to app state
        appState.subscriptionTier = 'free'; // 'free', 'premium', 'teacher'

        // Battle Mode State
        let currentBattleMode = 'bot'; // 'bot' or 'classmates'

        // Battle Mode Switching
        function switchBattleMode(mode) {
            currentBattleMode = mode;
            
            const botBtn = document.getElementById('botModeBtn');
            const classmatesBtn = document.getElementById('classmatesModeBtn');
            const botView = document.getElementById('botBattleView');
            const classmatesView = document.getElementById('classmatesBattleView');
            
            if (mode === 'bot') {
                // Update button styles
                botBtn.className = 'px-4 py-2 rounded-md bg-white/30 text-white font-medium transition-all';
                classmatesBtn.className = 'px-4 py-2 rounded-md text-white/70 hover:bg-white/20 font-medium transition-all';
                
                // Show/hide views
                botView.classList.remove('hidden');
                classmatesView.classList.add('hidden');
                
                showCustomAlert('ü§ñ Switched to AI Rival mode! Battle against your procrastination rival!');
            } else {
                // Update button styles
                classmatesBtn.className = 'px-4 py-2 rounded-md bg-white/30 text-white font-medium transition-all';
                botBtn.className = 'px-4 py-2 rounded-md text-white/70 hover:bg-white/20 font-medium transition-all';
                
                // Show/hide views
                classmatesView.classList.remove('hidden');
                botView.classList.add('hidden');
                
                showCustomAlert('üë• Switched to Classmates mode! Challenge your friends to study battles!');
            }
        }

        // Challenge Classmate Function
        function challengeClassmate(name, avatar, level) {
            showCustomAlert(`‚öîÔ∏è Challenging ${name} to a study battle! Pick a subject and show them who's the real scholar!`);
            
            // Create challenge modal
            const challengeModal = document.createElement('div');
            challengeModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            challengeModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
                    <div class="text-center mb-6">
                        <div class="text-6xl mb-4">${avatar}</div>
                        <h3 class="text-2xl font-bold mb-2">Challenge ${name}</h3>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Level ${level} ‚Ä¢ Choose your battle subject</div>
                    </div>
                    
                    <div class="space-y-3 mb-6">
                        <button onclick="startClassmateBattle('${name}', '${avatar}', 'math')" class="w-full bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 transition-colors">
                            üìä Math Battle
                        </button>
                        <button onclick="startClassmateBattle('${name}', '${avatar}', 'science')" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            üß™ Science Battle
                        </button>
                        <button onclick="startClassmateBattle('${name}', '${avatar}', 'history')" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-colors">
                            üìö History Battle
                        </button>
                        <button onclick="startClassmateBattle('${name}', '${avatar}', 'english')" class="w-full bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition-colors">
                            üìù English Battle
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full bg-gray-500 text-white py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(challengeModal);
        }

        // Start Classmate Battle
        function startClassmateBattle(opponentName, opponentAvatar, subject) {
            // Close challenge modal - find the specific challenge modal and remove it
            const challengeModals = document.querySelectorAll('.fixed.inset-0');
            challengeModals.forEach(modal => {
                if (modal.innerHTML.includes('Challenge ' + opponentName)) {
                    modal.remove();
                }
            });
            
            // Create a playable battle against classmate
            showCustomAlert(`‚öîÔ∏è Entering battlefield against ${opponentName}! Answer questions to prove your knowledge!`);
            
            // Initialize classmate battlefield state
            currentBattlefield = {
                taskId: 'classmate-battle',
                subject: subject,
                currentQuestion: 0,
                score: 0,
                opponentName: opponentName,
                opponentAvatar: opponentAvatar,
                studentBattleXP: gameState.studentXP,
                rivalBattleXP: gameState.rivalXP, // We'll simulate opponent progress
                studentBattleLevel: gameState.studentLevel,
                rivalBattleLevel: gameState.rivalLevel,
                isClassmateBattle: true
            };
            
            // Open battlefield interface for classmate battle
            openClassmateBattlefield(opponentName, opponentAvatar, subject);
        }

        // Open classmate battlefield interface
        function openClassmateBattlefield(opponentName, opponentAvatar, subject) {
            // Set battlefield title for classmate battle
            document.getElementById('battlefieldTitle').textContent = `‚öîÔ∏è ${subject.charAt(0).toUpperCase() + subject.slice(1)} Battle vs ${opponentName}`;
            
            // Initialize battle displays for classmate battle
            document.getElementById('battleStudentPower').textContent = `Level ${currentBattlefield.studentBattleLevel}`;
            document.getElementById('battleRivalPower').textContent = `Level ${currentBattlefield.rivalBattleLevel}`;
            
            // Show level progress as bars
            const studentProgress = getLevelProgress(currentBattlefield.studentBattleXP, currentBattlefield.studentBattleLevel);
            const rivalProgress = getLevelProgress(currentBattlefield.rivalBattleXP, currentBattlefield.rivalBattleLevel);
            
            document.getElementById('battleStudentBar').style.width = `${studentProgress}%`;
            document.getElementById('battleRivalBar').style.width = `${rivalProgress}%`;
            
            // Create classmate quiz questions for the subject
            const classmateQuizzes = {
                math: {
                    name: `Math Battle vs ${opponentName}`,
                    questions: [
                        {
                            question: "What is 25% of 200?",
                            options: ["40", "50", "60", "75"],
                            correct: 1
                        },
                        {
                            question: "Solve: 3x + 12 = 27",
                            options: ["x = 3", "x = 5", "x = 7", "x = 9"],
                            correct: 1
                        },
                        {
                            question: "What is the area of a rectangle with length 8 and width 6?",
                            options: ["28", "36", "42", "48"],
                            correct: 3
                        },
                        {
                            question: "What is 7¬≤?",
                            options: ["14", "42", "49", "56"],
                            correct: 2
                        }
                    ]
                },
                science: {
                    name: `Science Battle vs ${opponentName}`,
                    questions: [
                        {
                            question: "What gas do plants release during photosynthesis?",
                            options: ["Carbon dioxide", "Nitrogen", "Oxygen", "Hydrogen"],
                            correct: 2
                        },
                        {
                            question: "How many bones are in the adult human body?",
                            options: ["186", "206", "226", "246"],
                            correct: 1
                        },
                        {
                            question: "What is the speed of light?",
                            options: ["300,000 km/s", "150,000 km/s", "450,000 km/s", "600,000 km/s"],
                            correct: 0
                        },
                        {
                            question: "What is the chemical symbol for iron?",
                            options: ["Ir", "In", "Fe", "Fi"],
                            correct: 2
                        }
                    ]
                },
                history: {
                    name: `History Battle vs ${opponentName}`,
                    questions: [
                        {
                            question: "Who was the first president of the United States?",
                            options: ["John Adams", "George Washington", "Thomas Jefferson", "Benjamin Franklin"],
                            correct: 1
                        },
                        {
                            question: "In what year did the American Civil War end?",
                            options: ["1863", "1864", "1865", "1866"],
                            correct: 2
                        },
                        {
                            question: "Which empire was ruled by Julius Caesar?",
                            options: ["Greek Empire", "Roman Empire", "Persian Empire", "Egyptian Empire"],
                            correct: 1
                        },
                        {
                            question: "What year did World War I begin?",
                            options: ["1912", "1914", "1916", "1918"],
                            correct: 1
                        }
                    ]
                },
                english: {
                    name: `English Battle vs ${opponentName}`,
                    questions: [
                        {
                            question: "What is the plural of 'child'?",
                            options: ["childs", "children", "childes", "child"],
                            correct: 1
                        },
                        {
                            question: "Which word is a synonym for 'angry'?",
                            options: ["happy", "sad", "furious", "tired"],
                            correct: 2
                        },
                        {
                            question: "What is the past tense of 'run'?",
                            options: ["runned", "ran", "runs", "running"],
                            correct: 1
                        },
                        {
                            question: "What type of word is 'quickly'?",
                            options: ["noun", "verb", "adjective", "adverb"],
                            correct: 3
                        }
                    ]
                }
            };
            
            // Update the battlefield with classmate quiz data
            battlefieldQuizzes[subject] = classmateQuizzes[subject] || classmateQuizzes.math;
            
            // Set question progress
            const totalQuestions = battlefieldQuizzes[subject].questions.length;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('currentQuestionNum').textContent = '1';
            document.getElementById('questionProgress').style.width = '0%';
            
            // Custom ready screen for classmate battles
            document.getElementById('battleQuestionContent').innerHTML = `
                <div class="text-center">
                    <div class="flex justify-center items-center space-x-4 mb-6">
                        <div class="text-center">
                            <div class="text-4xl mb-2">üß†</div>
                            <div class="font-bold">You</div>
                            <div class="text-sm text-blue-600">Level ${gameState.studentLevel}</div>
                        </div>
                        <div class="text-6xl text-gray-400">VS</div>
                        <div class="text-center">
                            <div class="text-4xl mb-2">${opponentAvatar}</div>
                            <div class="font-bold">${opponentName}</div>
                            <div class="text-sm text-gray-600">Classmate</div>
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold mb-4">Ready for ${subject.charAt(0).toUpperCase() + subject.slice(1)} Battle?</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">First to answer correctly wins each round! Show ${opponentName} your knowledge!</p>
                    <button onclick="startBattleQuiz()" class="bg-primary text-white px-8 py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium text-lg">
                        ‚öîÔ∏è Begin Battle!
                    </button>
                </div>
            `;
            
            // Show battlefield modal
            document.getElementById('battlefieldModal').classList.remove('hidden');
        }

        // Global Rhino controls (persistent across mode switches)
        let rhinoChatEnabled = true;
        let scheduleEnabled = false;
        let scheduleLockStart = '09:00';
        let scheduleLockEnd = '11:00';

        function toggleRhinoChatTeacher() {
            rhinoChatEnabled = !rhinoChatEnabled;
            
            const toggleBtn = document.getElementById('rhinoToggleBtn');
            const statusText = document.getElementById('rhinoStatusText');
            const studentViewStatus = document.getElementById('studentViewStatus');
            const studentViewIcon = document.getElementById('studentViewIcon');

            if (rhinoChatEnabled) {
                toggleBtn.textContent = 'üü¢ Enabled';
                toggleBtn.className = 'bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm font-medium pointer-events-none';
                statusText.textContent = 'Currently enabled for all students';
                studentViewStatus.textContent = 'Students can currently access Rhino AI tutor';
                studentViewIcon.textContent = 'ü¶è';
            } else {
                toggleBtn.textContent = 'üî¥ Disabled';
                toggleBtn.className = 'bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-medium pointer-events-none';
                statusText.textContent = 'Currently disabled for all students';
                studentViewStatus.textContent = 'Students cannot currently access Rhino AI tutor';
                studentViewIcon.textContent = 'üîí';
            }

            updateRhinoChatButton();
            showCustomAlert(rhinoChatEnabled ? 'ü¶è Rhino Chat enabled for all students!' : 'üîí Rhino Chat disabled for all students.');
        }

        function toggleScheduleLock() {
            scheduleEnabled = document.getElementById('enableScheduleLock').checked;
            const scheduleControls = document.getElementById('scheduleControls');
            
            if (scheduleEnabled) {
                scheduleControls.style.opacity = '1';
                scheduleControls.querySelectorAll('input').forEach(input => input.disabled = false);
                updateScheduleLock();
            } else {
                scheduleControls.style.opacity = '0.5';
                scheduleControls.querySelectorAll('input').forEach(input => input.disabled = true);
                document.getElementById('scheduleStatus').textContent = '‚è∏Ô∏è Automatic locking disabled';
            }
        }

        function updateScheduleLock() {
            if (!scheduleEnabled) return;
            
            scheduleLockStart = document.getElementById('lockStartTime').value;
            scheduleLockEnd = document.getElementById('lockEndTime').value;
            
            const startTime = new Date(`2000-01-01 ${scheduleLockStart}`);
            const endTime = new Date(`2000-01-01 ${scheduleLockEnd}`);
            
            const startFormatted = startTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
            const endFormatted = endTime.toLocaleTimeString([], {hour: 'numeric', minute: '2-digit'});
            
            document.getElementById('scheduleStatus').textContent = 
                `üïê Rhino will be locked from ${startFormatted} to ${endFormatted} on school days`;
        }

        // Legacy function for backward compatibility
        function toggleRhinoChat() {
            toggleRhinoChatTeacher();
        }

        // Update teacher Rhino UI to reflect current state
        function updateTeacherRhinoUI() {
            const toggleBtn = document.getElementById('rhinoToggleBtn');
            const statusText = document.getElementById('rhinoStatusText');
            const studentViewStatus = document.getElementById('studentViewStatus');
            const studentViewIcon = document.getElementById('studentViewIcon');

            if (!toggleBtn || !statusText || !studentViewStatus || !studentViewIcon) {
                return; // Elements not found, probably not in teacher mode
            }

            if (rhinoChatEnabled) {
                toggleBtn.textContent = 'üü¢ Enabled';
                toggleBtn.className = 'bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors text-sm font-medium pointer-events-none';
                statusText.textContent = 'Currently enabled for all students';
                studentViewStatus.textContent = 'Students can currently access Rhino AI tutor';
                studentViewIcon.textContent = 'ü¶è';
            } else {
                toggleBtn.textContent = 'üî¥ Disabled';
                toggleBtn.className = 'bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors text-sm font-medium pointer-events-none';
                statusText.textContent = 'Currently disabled for all students';
                studentViewStatus.textContent = 'Students cannot currently access Rhino AI tutor';
                studentViewIcon.textContent = 'üîí';
            }

            // Update schedule controls if they exist
            const enableScheduleLock = document.getElementById('enableScheduleLock');
            const lockStartTime = document.getElementById('lockStartTime');
            const lockEndTime = document.getElementById('lockEndTime');
            const scheduleControls = document.getElementById('scheduleControls');

            if (enableScheduleLock) {
                enableScheduleLock.checked = scheduleEnabled;
            }
            if (lockStartTime) {
                lockStartTime.value = scheduleLockStart;
            }
            if (lockEndTime) {
                lockEndTime.value = scheduleLockEnd;
            }
            if (scheduleControls) {
                if (scheduleEnabled) {
                    scheduleControls.style.opacity = '1';
                    scheduleControls.querySelectorAll('input').forEach(input => input.disabled = false);
                    updateScheduleLock();
                } else {
                    scheduleControls.style.opacity = '0.5';
                    scheduleControls.querySelectorAll('input').forEach(input => input.disabled = true);
                    const scheduleStatus = document.getElementById('scheduleStatus');
                    if (scheduleStatus) {
                        scheduleStatus.textContent = '‚è∏Ô∏è Automatic locking disabled';
                    }
                }
            }
        }

        // Update Rhino chat button based on teacher settings
        function updateRhinoChatButton() {
            const rhinoButton = document.getElementById('rhinoChatButton');
            if (!rhinoButton) return;

            if (rhinoChatEnabled) {
                rhinoButton.className = 'w-full bg-gradient-to-r from-purple-500 to-blue-500 text-white p-4 rounded-lg hover:from-purple-600 hover:to-blue-600 transition-all duration-300 shadow-lg hover:shadow-xl transform hover:scale-105';
                rhinoButton.innerHTML = `
                    <div class="flex items-center justify-center space-x-3">
                        <span class="text-2xl">ü¶è</span>
                        <div class="text-left">
                            <div class="font-bold">Chat with Rhino</div>
                            <div class="text-sm opacity-90">Ask questions, get help instantly!</div>
                        </div>
                    </div>
                `;
                rhinoButton.onclick = openAITutorChat;
            } else {
                rhinoButton.className = 'w-full bg-gray-400 text-gray-600 p-4 rounded-lg cursor-not-allowed opacity-75';
                rhinoButton.innerHTML = `
                    <div class="flex items-center justify-center space-x-3">
                        <span class="text-2xl">üîí</span>
                        <div class="text-left">
                            <div class="font-bold">Rhino Chat Locked</div>
                            <div class="text-sm opacity-90">Teacher has disabled chat during class time</div>
                        </div>
                    </div>
                `;
                rhinoButton.onclick = () => {
                    showCustomAlert('üîí Rhino Chat is currently locked by your teacher. Available after class!');
                };
            }
        }

        // AI Tutor Chat functionality
        async function openAITutorChat() {
            if (!rhinoChatEnabled) {
                showCustomAlert('üîí Rhino Chat is currently locked by your teacher. Available after class!');
                return;
            }

            // For demo, we'll simulate a chat interface
            const chatModal = document.createElement('div');
            chatModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            chatModal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
                    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <span class="text-3xl">ü¶è</span>
                                <div>
                                    <h3 class="text-xl font-bold">Rhino AI Tutor</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Your personal study assistant</p>
                                </div>
                            </div>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">‚úï</button>
                        </div>
                    </div>
                    
                    <div id="chatMessages" class="flex-1 p-6 overflow-y-auto space-y-4 max-h-96">
                        <div class="flex items-start space-x-3">
                            <span class="text-2xl">ü¶è</span>
                            <div class="bg-purple-100 dark:bg-purple-900/30 rounded-lg p-3 flex-1">
                                <p class="text-purple-800 dark:text-purple-200">Hi! I'm Rhino, your AI study buddy! I can help you with homework, explain concepts, or just chat about what you're learning. What can I help you with today?</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 border-t border-gray-200 dark:border-gray-700">
                        <div class="flex space-x-3">
                            <input type="text" id="chatInput" placeholder="Ask Rhino anything about your studies..." class="flex-1 px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white" onkeypress="if(event.key==='Enter') sendChatMessage()">
                            <button onclick="sendChatMessage()" class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition-colors font-medium">
                                Send
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">üí° Try asking: "Help me with algebra" or "Explain photosynthesis"</div>
                    </div>
                </div>
            `;
            document.body.appendChild(chatModal);
            
            // Focus the input
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 100);
        }

        // Send chat message to Rhino
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById('chatMessages');
            
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'flex items-start space-x-3 justify-end';
            userMessage.innerHTML = `
                <div class="bg-blue-100 dark:bg-blue-900/30 rounded-lg p-3">
                    <p class="text-blue-800 dark:text-blue-200">${message}</p>
                </div>
                <span class="text-2xl">üß†</span>
            `;
            chatMessages.appendChild(userMessage);
            
            // Clear input
            input.value = '';
            
            // Add loading message
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'flex items-start space-x-3';
            loadingMessage.innerHTML = `
                <span class="text-2xl">ü¶è</span>
                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-3 flex-1">
                    <p class="text-gray-600 dark:text-gray-400">Rhino is thinking... ü§î</p>
                </div>
            `;
            chatMessages.appendChild(loadingMessage);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Register handler for Rhino's response
                window.Poe.registerHandler("rhino-chat", (result) => {
                    const response = result.responses[0];
                    if (response.status === "complete" || response.status === "incomplete") {
                        // Remove loading message
                        if (loadingMessage.parentNode) {
                            loadingMessage.remove();
                        }
                        
                        // Add or update Rhino's response
                        let rhinoResponse = document.getElementById('current-rhino-response');
                        if (!rhinoResponse) {
                            rhinoResponse = document.createElement('div');
                            rhinoResponse.id = 'current-rhino-response';
                            rhinoResponse.className = 'flex items-start space-x-3';
                            rhinoResponse.innerHTML = `
                                <span class="text-2xl">ü¶è</span>
                                <div class="bg-purple-100 dark:bg-purple-900/30 rounded-lg p-3 flex-1">
                                    <p class="text-purple-800 dark:text-purple-200" id="rhino-response-text"></p>
                                </div>
                            `;
                            chatMessages.appendChild(rhinoResponse);
                        }
                        
                        // Update response text
                        const responseText = document.getElementById('rhino-response-text');
                        if (responseText) {
                            responseText.textContent = response.content;
                        }
                        
                        // If complete, remove the ID so future responses create new elements
                        if (response.status === "complete") {
                            rhinoResponse.removeAttribute('id');
                        }
                        
                        // Scroll to bottom
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    } else if (response.status === "error") {
                        // Remove loading message and show error
                        if (loadingMessage.parentNode) {
                            loadingMessage.remove();
                        }
                        
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'flex items-start space-x-3';
                        errorMessage.innerHTML = `
                            <span class="text-2xl">ü¶è</span>
                            <div class="bg-red-100 dark:bg-red-900/30 rounded-lg p-3 flex-1">
                                <p class="text-red-800 dark:text-red-200">Sorry, I'm having trouble right now. Please try again!</p>
                            </div>
                        `;
                        chatMessages.appendChild(errorMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });

                // Send message to Claude as Rhino
                await window.Poe.sendUserMessage(
                    `@Claude-Sonnet-4 You are Rhino, a friendly AI tutor for students. Respond in a helpful, encouraging way to this student question: "${message}". Keep responses concise but informative. Use emojis sparingly and be supportive of their learning journey.`,
                    {
                        handler: "rhino-chat",
                        stream: true,
                        openChat: false
                    }
                );
            } catch (error) {
                // Remove loading message and show error
                if (loadingMessage.parentNode) {
                    loadingMessage.remove();
                }
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'flex items-start space-x-3';
                errorMessage.innerHTML = `
                    <span class="text-2xl">ü¶è</span>
                    <div class="bg-red-100 dark:bg-red-900/30 rounded-lg p-3 flex-1">
                        <p class="text-red-800 dark:text-red-200">Sorry, I'm having trouble connecting right now. Please try again!</p>
                    </div>
                `;
                chatMessages.appendChild(errorMessage);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Initialize
        updatePowerLevels();
        updateBattleCountdown();
        setInterval(updateBattleCountdown, 60000); // Update every minute
    </script>
</body>
</html>
